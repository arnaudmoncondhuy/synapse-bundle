{% extends '@Synapse/admin/layout.html.twig' %}

{% block admin_title %}Presets LLM — Synapse Admin{% endblock %}

{% block admin_content %}
<div class="synapse-admin__page">
	<div class="synapse-admin__page-header" style="display: flex; justify-content: space-between; align-items: flex-start">
		<div>
			<h1 class="synapse-admin__page-title">
				<i data-lucide="sliders-horizontal"></i>
				Presets LLM
			</h1>
			<p class="synapse-admin__page-subtitle">
				Créez et gérez vos configurations LLM par scope d'application.
			</p>
		</div>
		<a href="{{ path('synapse_admin_presets_new') }}" class="synapse-admin__btn synapse-admin__btn--primary" style="white-space: nowrap">
			<i data-lucide="plus"></i>
			Nouveau preset
		</a>
	</div>

	{% if presets is empty %}
		<div class="synapse-admin__empty" style="text-align: center; padding: 3rem 2rem">
			<i data-lucide="sliders-horizontal" style="width: 64px; height: 64px; color: var(--synapse-admin-text-light); margin-bottom: 1rem; opacity: 0.5"></i>
			<h2 style="margin: 0 0 0.5rem 0; color: var(--synapse-admin-text-muted)">Aucun preset configuré</h2>
			<p style="margin: 0 0 1.5rem 0; color: var(--synapse-admin-text-light); font-size: 0.95rem">
				Créez votre premier preset pour commencer.
			</p>
			<a href="{{ path('synapse_admin_presets_new') }}" class="synapse-admin__btn synapse-admin__btn--primary">
				<i data-lucide="plus"></i> Créer le premier preset
			</a>
		</div>
	{% else %}
		{# Grouper par scope #}
		{% set scopes = {} %}
		{% for p in presets %}
			{% set preset = p.entity %}
			{% set scope = preset.scope %}
			{% if scopes[scope] is not defined %}
				{% set scopes = scopes|merge({(scope): []}) %}
			{% endif %}
			{% set scopes = scopes|merge({(scope): scopes[scope]|merge([p])}) %}
		{% endfor %}

		{% for scope, scopePresets in scopes %}
			<div class="synapse-admin__section" style="margin-bottom: 3rem">
				<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--synapse-admin-border)">
					<i data-lucide="tag" style="width: 20px; height: 20px; color: var(--synapse-admin-primary)"></i>
					<h2 class="synapse-admin__section-title" style="margin: 0; font-size: 1.25rem">
						{{ scope }}
					</h2>
					<span style="margin-left: auto; background: var(--synapse-admin-primary-fade); color: var(--synapse-admin-primary); padding: 0.25rem 0.75rem; border-radius: var(--synapse-admin-radius-full); font-size: 0.85rem; font-weight: 600">
						{{ scopePresets|length }} preset{{ scopePresets|length > 1 ? 's' : '' }}
					</span>
				</div>

				<div class="synapse-admin__grid synapse-admin__grid--2" style="gap: 1.5rem">
					{% for p in scopePresets %}
						{% set preset = p.entity %}
						{% set caps = p.caps %}
						<div class="synapse-admin__card synapse-admin__card--hover"
						     style="{% if preset.isActive %}border-top: 3px solid var(--synapse-admin-success); position: relative{% else %}border-top: 3px solid var(--synapse-admin-border){% endif %}">

							<!-- Active indicator -->
							{% if preset.isActive %}
								<div style="position: absolute; top: 0; right: 0; background: var(--synapse-admin-success); color: white; padding: 0.5rem 1rem; border-radius: 0 0 0 0.5rem; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem">
									<i data-lucide="check-circle" style="width: 14px; height: 14px"></i>
									ACTIF
								</div>
							{% endif %}

							<!-- Header -->
							<div class="synapse-admin__card-header" style="display: block; padding: 1.5rem">
								<h3 style="margin: 0 0 0.25rem 0; font-size: 1.1rem; color: var(--synapse-admin-text-main)">
									{{ preset.name }}
								</h3>
								{% if preset.description %}
									<p style="margin: 0; font-size: 0.85rem; color: var(--synapse-admin-text-muted); line-height: 1.4">
										{{ preset.description }}
									</p>
								{% endif %}
							</div>

							<!-- Provider & Model -->
							<div class="synapse-admin__card-body" style="border-top: 1px solid var(--synapse-admin-border); border-bottom: 1px solid var(--synapse-admin-border); padding: 1rem 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
								<div>
									<p style="margin: 0 0 0.25rem 0; font-size: 0.75rem; font-weight: 600; color: var(--synapse-admin-text-muted); text-transform: uppercase; letter-spacing: 0.05em">
										<i data-lucide="plug" style="width: 14px; height: 14px; margin-right: 0.25rem; display: inline"></i>
										Provider
									</p>
									<p style="margin: 0; font-size: 0.95rem; font-weight: 600; color: var(--synapse-admin-text-main)">
										{{ preset.providerName|capitalize }}
									</p>
								</div>
								<div>
									<p style="margin: 0 0 0.25rem 0; font-size: 0.75rem; font-weight: 600; color: var(--synapse-admin-text-muted); text-transform: uppercase; letter-spacing: 0.05em">
										<i data-lucide="cpu" style="width: 14px; height: 14px; margin-right: 0.25rem; display: inline"></i>
										Modèle
									</p>
									<code style="font-size: 0.9rem; color: var(--synapse-admin-text-main); font-weight: 500">{{ preset.model }}</code>
								</div>
							</div>

							<!-- Config -->
							<div class="synapse-admin__card-body" style="border-bottom: 1px solid var(--synapse-admin-border); padding: 1rem 1.5rem">
								<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem">
									<p style="margin: 0; font-size: 0.75rem; font-weight: 600; color: var(--synapse-admin-text-muted); text-transform: uppercase; letter-spacing: 0.05em">
										Configuration
									</p>
									<div style="display: flex; gap: 0.5rem">
										{% if caps.thinking %}<i data-lucide="brain" title="Thinking" style="width: 14px; color: var(--synapse-admin-success)"></i>{% endif %}
										{% if caps.functionCalling %}<i data-lucide="wrench" title="Tool calls" style="width: 14px; color: var(--synapse-admin-success)"></i>{% endif %}
										{% if caps.safetySettings %}<i data-lucide="shield" title="Safety" style="width: 14px; color: var(--synapse-admin-success)"></i>{% endif %}
										{% if caps.streaming %}<i data-lucide="activity" title="Streaming" style="width: 14px; color: var(--synapse-admin-success)"></i>{% endif %}
									</div>
								</div>
								<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem">
									<div style="background: var(--synapse-admin-bg-main); padding: 0.5rem; border-radius: 0.375rem">
										<span style="color: var(--synapse-admin-text-muted)">Temp:</span>
										<strong style="margin-left: 0.25rem; color: var(--synapse-admin-text-main)">{{ preset.generationTemperature }}</strong>
									</div>
									<div style="background: var(--synapse-admin-bg-main); padding: 0.5rem; border-radius: 0.375rem">
										<span style="color: var(--synapse-admin-text-muted)">Thinking:</span>
										<strong style="margin-left: 0.25rem; color: var(--synapse-admin-text-main)">
											{% if preset.thinkingEnabled and caps.thinking %}
												{{ preset.thinkingBudget }}t
											{% else %}
												—
											{% endif %}
										</strong>
									</div>
								</div>
							</div>

							<!-- Metadata -->
							<div class="synapse-admin__card-body" style="padding: 0.75rem 1.5rem; background: var(--synapse-admin-bg-main); font-size: 0.8rem; color: var(--synapse-admin-text-muted)">
								Mis à jour le {{ preset.updatedAt|date('d/m/Y à H:i') }}
							</div>

							<!-- Actions -->
							<div class="synapse-admin__card-footer" style="padding: 1rem 1.5rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem">
								{% if not preset.isActive %}
									<form method="post"
									      action="{{ path('synapse_admin_presets_activate', {id: preset.id}) }}"
									      style="display: contents">
										<button type="submit"
										        class="synapse-admin__btn synapse-admin__btn--sm synapse-admin__btn--primary"
										        title="Activer ce preset"
										        style="width: 100%">
											<i data-lucide="play"></i>
										</button>
									</form>
								{% else %}
									<div></div>
								{% endif %}
								<a href="{{ path('synapse_admin_presets_edit', {id: preset.id}) }}"
								   class="synapse-admin__btn synapse-admin__btn--sm synapse-admin__btn--ghost"
								   title="Éditer"
								   style="width: 100%">
									<i data-lucide="pencil"></i>
								</a>
								<form method="post"
								      action="{{ path('synapse_admin_presets_clone', {id: preset.id}) }}"
								      style="display: contents">
									<button type="submit"
									        class="synapse-admin__btn synapse-admin__btn--sm synapse-admin__btn--ghost"
									        title="Dupliquer"
									        style="width: 100%">
										<i data-lucide="copy"></i>
									</button>
								</form>
								{% if not preset.isActive %}
									<form method="post"
									      action="{{ path('synapse_admin_presets_delete', {id: preset.id}) }}"
									      style="display: contents"
									      onsubmit="return confirm('Supprimer le preset « {{ preset.name }} » ?')">
										<button type="submit"
										        class="synapse-admin__btn synapse-admin__btn--sm synapse-admin__btn--danger"
										        title="Supprimer"
										        style="width: 100%">
											<i data-lucide="trash-2"></i>
										</button>
									</form>
								{% else %}
									<div></div>
								{% endif %}
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
		{% endfor %}
	{% endif %}
</div>

<script>
if (typeof lucide !== 'undefined') { lucide.createIcons(); }
</script>
{% endblock %}
