{% extends '@Synapse/admin/layout.html.twig' %}

{% block admin_title %}Presets LLM — Synapse Admin{% endblock %}

{% block admin_content %}
<div class="synapse-admin__page">
	<div class="synapse-admin__page-header" style="display: flex; justify-content: space-between; align-items: flex-start">
		<div>
			<h1 class="synapse-admin__page-title">
				<i data-lucide="sliders-horizontal"></i>
				Presets LLM
			</h1>
			<p class="synapse-admin__page-subtitle">
				Créez et gérez vos configurations LLM par scope d'application.
			</p>
		</div>
		<a href="{{ path('synapse_admin_presets_new') }}" class="synapse-admin__btn synapse-admin__btn--primary" style="white-space: nowrap">
			<i data-lucide="plus"></i>
			Nouveau preset
		</a>
	</div>

	{# Info banner about presets concept #}
	<div class="synapse-admin__card" style="background: rgba(0, 102, 204, 0.05); border-left: 4px solid var(--synapse-admin-primary); margin-bottom: 1.5rem;">
		<div style="display: flex; gap: 1rem; align-items: flex-start; padding: 1rem 1.5rem;">
			<i data-lucide="info" style="width: 20px; height: 20px; color: var(--synapse-admin-primary); flex-shrink: 0; margin-top: 0.1rem;"></i>
			<div>
				<p style="margin: 0; font-weight: 600; color: var(--synapse-admin-text-main);">À propos des presets</p>
				<p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--synapse-admin-text-secondary);">
					Un preset est une configuration de modèle LLM complète (provider, modèle, paramètres, capacités). Organisés par <strong>scope</strong> (contexte d'utilisation), un seul preset est actif par scope.
				</p>
			</div>
		</div>
	</div>

	{% if presets is empty %}
		<div class="synapse-admin__empty" style="text-align: center; padding: 3rem 2rem">
			<i data-lucide="sliders-horizontal" style="width: 64px; height: 64px; color: var(--synapse-admin-text-light); margin-bottom: 1rem; opacity: 0.5"></i>
			<h2 style="margin: 0 0 0.5rem 0; color: var(--synapse-admin-text-muted)">Aucun preset configuré</h2>
			<p style="margin: 0 0 1.5rem 0; color: var(--synapse-admin-text-light); font-size: 0.95rem">
				Créez votre premier preset pour commencer.
			</p>
			<a href="{{ path('synapse_admin_presets_new') }}" class="synapse-admin__btn synapse-admin__btn--primary">
				<i data-lucide="plus"></i> Créer le premier preset
			</a>
		</div>
	{% else %}
		{# Grouper par scope #}
		{% set scopes = {} %}
		{% for p in presets %}
			{% set preset = p.entity %}
			{% set scope = preset.scope %}
			{% if scopes[scope] is not defined %}
				{% set scopes = scopes|merge({(scope): []}) %}
			{% endif %}
			{% set scopes = scopes|merge({(scope): scopes[scope]|merge([p])}) %}
		{% endfor %}

		{% for scope, scopePresets in scopes %}
			<div class="synapse-admin__section" style="margin-bottom: 3rem">
				<div class="synapse-admin__scope-header">
					<div class="synapse-admin__scope-label">
						<i data-lucide="tag" style="width: 18px; height: 18px;"></i>
						{{ scope }}
					</div>
					<span style="background: var(--synapse-admin-primary-fade); color: var(--synapse-admin-primary); padding: 0.25rem 0.75rem; border-radius: var(--synapse-admin-radius-full); font-size: 0.85rem; font-weight: 600">
						{{ scopePresets|length }} preset{{ scopePresets|length > 1 ? 's' : '' }}
					</span>
				</div>

				<div class="synapse-admin__grid synapse-admin__grid--2" style="gap: 1.5rem">
					{% for p in scopePresets %}
						{% set preset = p.entity %}
						{% set caps = p.caps %}
						<div class="synapse-admin__card synapse-admin__card--hover"
						     style="border-top: 3px solid {% if preset.isActive %}var(--synapse-admin-success){% else %}var(--synapse-admin-border){% endif %}">

							<!-- Header -->
							<div class="synapse-admin__card-header" style="display: flex; justify-content: space-between; align-items: flex-start; padding: 1.5rem">
								<div style="flex: 1">
									<h3 style="margin: 0 0 0.25rem 0; font-size: 1.1rem; color: var(--synapse-admin-text-main)">
											{{ preset.name }}
									</h3>
									{% if preset.description %}
										<p style="margin: 0; font-size: 0.85rem; color: var(--synapse-admin-text-muted); line-height: 1.4">
											{{ preset.description }}
										</p>
									{% endif %}
								</div>
								{% if preset.isActive %}
									<span class="synapse-admin__badge synapse-admin__badge--success" style="white-space: nowrap;">
										<i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
										Actif
									</span>
								{% endif %}
							</div>

							<!-- Provider & Model -->
							<div class="synapse-admin__card-body" style="border-top: 1px solid var(--synapse-admin-border); border-bottom: 1px solid var(--synapse-admin-border); padding: 1rem 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
								<div>
									<p style="margin: 0 0 0.25rem 0; font-size: 0.75rem; font-weight: 600; color: var(--synapse-admin-text-muted); text-transform: uppercase; letter-spacing: 0.05em">
										<i data-lucide="plug" style="width: 14px; height: 14px; margin-right: 0.25rem; display: inline"></i>
										Provider
									</p>
									<p style="margin: 0; font-size: 0.95rem; font-weight: 600; color: var(--synapse-admin-text-main)">
										{{ preset.providerName|capitalize }}
									</p>
								</div>
								<div>
									<p style="margin: 0 0 0.25rem 0; font-size: 0.75rem; font-weight: 600; color: var(--synapse-admin-text-muted); text-transform: uppercase; letter-spacing: 0.05em">
										<i data-lucide="cpu" style="width: 14px; height: 14px; margin-right: 0.25rem; display: inline"></i>
										Modèle
									</p>
									<code style="font-size: 0.9rem; color: var(--synapse-admin-text-main); font-weight: 500">{{ preset.model }}</code>
								</div>
							</div>

							<!-- Config -->
							<div class="synapse-admin__card-body" style="border-bottom: 1px solid var(--synapse-admin-border); padding: 1rem 1.5rem">
								<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem">
									<p style="margin: 0; font-size: 0.75rem; font-weight: 600; color: var(--synapse-admin-text-muted); text-transform: uppercase; letter-spacing: 0.05em">
										Configuration
									</p>
									<div style="display: flex; gap: 0.5rem">
										{% if caps.thinking %}<i data-lucide="brain" title="Thinking" style="width: 14px; color: var(--synapse-admin-success)"></i>{% endif %}
										{% if caps.functionCalling %}<i data-lucide="wrench" title="Tool calls" style="width: 14px; color: var(--synapse-admin-success)"></i>{% endif %}
										{% if caps.safetySettings %}<i data-lucide="shield" title="Safety" style="width: 14px; color: var(--synapse-admin-success)"></i>{% endif %}
										{% if caps.streaming %}<i data-lucide="activity" title="Streaming" style="width: 14px; color: var(--synapse-admin-success)"></i>{% endif %}
									</div>
								</div>
								<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem">
									<div style="background: var(--synapse-admin-bg-main); padding: 0.5rem; border-radius: 0.375rem">
										<span style="color: var(--synapse-admin-text-muted)">Temp:</span>
										<strong style="margin-left: 0.25rem; color: var(--synapse-admin-text-main)">{{ preset.generationTemperature }}</strong>
									</div>
									<div style="background: var(--synapse-admin-bg-main); padding: 0.5rem; border-radius: 0.375rem">
										<span style="color: var(--synapse-admin-text-muted)">Thinking:</span>
										<strong style="margin-left: 0.25rem; color: var(--synapse-admin-text-main)">
											{% if preset.thinkingEnabled and caps.thinking %}
												{{ preset.thinkingBudget }}t
											{% else %}
												—
											{% endif %}
										</strong>
									</div>
								</div>
							</div>

							<!-- Metadata -->
							<div class="synapse-admin__card-body" style="padding: 0.75rem 1.5rem; background: var(--synapse-admin-bg-main); font-size: 0.8rem; color: var(--synapse-admin-text-muted)">
								Mis à jour le {{ preset.updatedAt|date('d/m/Y à H:i') }}
							</div>

							<!-- Actions -->
							<div class="synapse-admin__card-footer" style="padding: 1rem 1.5rem; display: flex; gap: 0.5rem">
								{% if not preset.isActive %}
									<form method="post"
									      action="{{ path('synapse_admin_presets_activate', {id: preset.id}) }}"
									      style="flex: 1;">
										<button type="submit"
										        class="synapse-admin__btn synapse-admin__btn--sm synapse-admin__btn--primary"
										        style="width: 100%">
											<i data-lucide="play" style="width: 14px; height: 14px;"></i>
											Activer
										</button>
									</form>
								{% endif %}
								<a href="{{ path('synapse_admin_presets_edit', {id: preset.id}) }}"
								   class="synapse-admin__btn synapse-admin__btn--sm synapse-admin__btn--ghost"
								   style="flex: 1;">
									<i data-lucide="pencil" style="width: 14px; height: 14px;"></i>
									Modifier
								</a>
								<form method="post"
								      action="{{ path('synapse_admin_presets_clone', {id: preset.id}) }}"
								      style="flex: 1;">
									<button type="submit"
									        class="synapse-admin__btn synapse-admin__btn--sm synapse-admin__btn--ghost"
									        style="width: 100%">
										<i data-lucide="copy" style="width: 14px; height: 14px;"></i>
										Dupliquer
									</button>
								</form>
								{% if not preset.isActive %}
									<form method="post"
									      action="{{ path('synapse_admin_presets_delete', {id: preset.id}) }}"
									      style="display: contents"
									      onsubmit="return confirm('Supprimer le preset « {{ preset.name }} » ?')">
										<button type="submit"
										        class="synapse-admin__btn synapse-admin__btn--sm synapse-admin__btn--danger"
										        title="Supprimer"
										        style="padding: 0.5rem;">
											<i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
										</button>
									</form>
								{% endif %}
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
		{% endfor %}
	{% endif %}
</div>

<script>
if (typeof lucide !== 'undefined') { lucide.createIcons(); }
</script>
{% endblock %}
