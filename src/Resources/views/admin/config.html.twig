{% extends '@Synapse/admin/_layout.html.twig' %}

{% block admin_content %}
	<header class="syn-header">
		<div>
			<h1 class="syn-title">Configuration</h1>
			<p class="syn-subtitle">Param√®tres globaux de l'assistant et du mod√®le IA</p>
		</div>
	</header>

	<div style="max-width: 1000px; padding-bottom: 4rem;">
		<form
			method="post">

			<!-- ============================= MOD√àLE IA ============================= -->
			<div class="syn-card mb-6" style="margin-bottom: 2rem;">
				<div class="syn-card-header">
					<div class="syn-kpi-icon primary" style="width: 32px; height: 32px; font-size: 1rem; border-radius: 6px;">
						<i data-lucide="cpu"></i>
					</div>
					<div>
						<h2 style="font-size: 1.1rem; margin: 0;">Mod√®le IA</h2>
						<p style="margin: 0; font-size: 0.9rem; color: var(--syn-text-muted);">S√©lectionnez la version du mod√®le Gemini √† utiliser.</p>
					</div>
				</div>

				<div class="syn-card-body">
					<div class="syn-form-group">
						<label class="syn-label">Version du Mod√®le</label>
						<input type="text" name="gemini_model" class="syn-input" value="{{ config.model }}" placeholder="ex: gemini-2.5-flash" required>
						<p class="syn-help">R√©f√©rez-vous √† la documentation Vertex AI pour les mod√®les disponibles.</p>
					</div>
				</div>
			</div>

			<!-- ============================= PROMPT SYST√àME ============================= -->
			<div class="syn-card mb-6" style="margin-bottom: 2rem;">
				<div class="syn-card-header">
					<div class="syn-kpi-icon warning" style="width: 32px; height: 32px; font-size: 1rem; border-radius: 6px;">
						<i data-lucide="message-square-quote"></i>
					</div>
					<div>
						<h2 style="font-size: 1.1rem; margin: 0;">Prompt Syst√®me</h2>
						<p style="margin: 0; font-size: 0.9rem; color: var(--syn-text-muted);">D√©finissez le comportement global et le contexte de l'assistant.</p>
					</div>
				</div>

				<div class="syn-card-body">
					<div class="syn-alert syn-alert-info">
						<i data-lucide="info" style="flex-shrink: 0; margin-top: 2px;"></i>
						<div>
							<strong style="display: block; margin-bottom: 0.25rem;">Variables Dynamiques</strong>
							<p style="margin: 0; font-size: 0.9rem;">Vous pouvez utiliser :
								<code>{DATE}</code>,
								<code>{NOM}</code>,
								<code>{PRENOM}</code>,
								<code>{EMAIL}</code>,
								<code>{ROLE}</code>.</p>
						</div>
					</div>

					<div class="syn-form-group">
						<label class="syn-label">Instructions Personnalis√©es</label>
						<textarea name="system_prompt" class="syn-textarea" rows="12" placeholder="Laissez vide pour utiliser le prompt par d√©faut..." style="font-family: monospace;">{{ config.systemPrompt }}</textarea>
						<p class="syn-help">Ces instructions remplacent le prompt par d√©faut.</p>
					</div>
				</div>
			</div>

			<!-- ============================= S√âCURIT√â ============================= -->
			<div class="syn-card mb-6" style="margin-bottom: 2rem;">
				<div class="syn-card-header">
					<div class="syn-kpi-icon error" style="width: 32px; height: 32px; font-size: 1rem; border-radius: 6px;">
						<i data-lucide="shield-alert"></i>
					</div>
					<div>
						<h2 style="font-size: 1.1rem; margin: 0;">Filtres de S√©curit√©</h2>
						<p style="margin: 0; font-size: 0.9rem; color: var(--syn-text-muted);">Contr√¥le du contenu g√©n√©r√© (recommand√© pour environnement scolaire).</p>
					</div>
				</div>

				<div class="syn-card-body">
					<div style="background: var(--syn-bg-main); padding: 1rem; border-radius: var(--syn-radius-sm); border: 1px solid var(--syn-border); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
						<input type="checkbox" name="safety_enabled" id="safety_enabled" value="1" {{ config.isSafetyEnabled ? 'checked' : '' }} style="width: 1.25rem; height: 1.25rem; accent-color: var(--syn-color-primary);">
						<div>
							<label for="safety_enabled" style="font-weight: 600; cursor: pointer; display: block;">Activer les filtres de s√©curit√©</label>
							<p style="margin: 0; font-size: 0.85rem; color: var(--syn-text-muted);">Bloque automatiquement les contenus inadapt√©s.</p>
						</div>
					</div>

					<div class="syn-form-group">
						<label class="syn-label">üõ°Ô∏è Seuil par D√©faut</label>
						<select name="safety_default_threshold" class="syn-select">
							{% for value, label in safety_thresholds %}
								<option value="{{ value }}" {{ config.safetyDefaultThreshold == value ? 'selected' : '' }}>{{ label }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="syn-grid-2">
						<div class="syn-form-group">
							<label class="syn-label">üí¨ Discours Haineux</label>
							<select name="safety_hate_speech" class="syn-select">
								{% for value, label in safety_thresholds %}
									<option value="{{ value }}" {{ config.safetyHateSpeech == value ? 'selected' : '' }}>{{ label }}</option>
								{% endfor %}
							</select>
						</div>

						<div class="syn-form-group">
							<label class="syn-label">‚ö†Ô∏è Contenu Dangereux</label>
							<select name="safety_dangerous_content" class="syn-select">
								{% for value, label in safety_thresholds %}
									<option value="{{ value }}" {{ config.safetyDangerousContent == value ? 'selected' : '' }}>{{ label }}</option>
								{% endfor %}
							</select>
						</div>

						<div class="syn-form-group">
							<label class="syn-label">üò† Harc√®lement</label>
							<select name="safety_harassment" class="syn-select">
								{% for value, label in safety_thresholds %}
									<option value="{{ value }}" {{ config.safetyHarassment == value ? 'selected' : '' }}>{{ label }}</option>
								{% endfor %}
							</select>
						</div>

						<div class="syn-form-group">
							<label class="syn-label">üîû Contenu Sexuel</label>
							<select name="safety_sexually_explicit" class="syn-select">
								{% for value, label in safety_thresholds %}
									<option value="{{ value }}" {{ config.safetySexuallyExplicit == value ? 'selected' : '' }}>{{ label }}</option>
								{% endfor %}
							</select>
						</div>
					</div>
				</div>
			</div>

			<!-- ============================= G√âN√âRATION ============================= -->
			<div class="syn-card mb-6" style="margin-bottom: 2rem;">
				<div class="syn-card-header">
					<div class="syn-kpi-icon primary" style="width: 32px; height: 32px; font-size: 1rem; border-radius: 6px;">
						<i data-lucide="settings"></i>
					</div>
					<div>
						<h2 style="font-size: 1.1rem; margin: 0;">Configuration de G√©n√©ration</h2>
						<p style="margin: 0; font-size: 0.9rem; color: var(--syn-text-muted);">Contr√¥le cr√©ativit√© et longueur des r√©ponses.</p>
					</div>
				</div>

				<div class="syn-card-body">
					<div class="syn-grid-3">
						<div class="syn-form-group">
							<label class="syn-label">üå°Ô∏è Temp√©rature</label>
							<input type="number" name="generation_temperature" class="syn-input" step="0.1" min="0" max="2" value="{{ config.generationTemperature }}">
							<p class="syn-help">0.0 (Strict) - 2.0 (Cr√©atif)</p>
						</div>

						<div class="syn-form-group">
							<label class="syn-label">üéØ Top-P (Nucleus)</label>
							<input type="number" name="generation_top_p" class="syn-input" step="0.01" min="0" max="1" value="{{ config.generationTopP }}">
						</div>

						<div class="syn-form-group">
							<label class="syn-label">üî¢ Top-K</label>
							<input type="number" name="generation_top_k" class="syn-input" min="1" value="{{ config.generationTopK }}">
						</div>

						<div class="syn-form-group">
							<label class="syn-label">üìè Limite Tokens</label>
							<input type="number" name="generation_max_output_tokens" class="syn-input" min="1" value="{{ config.generationMaxOutputTokens }}" placeholder="D√©faut">
						</div>
					</div>

					<div class="syn-form-group" style="margin-top: 1.5rem;">
						<label class="syn-label">üõë S√©quences d'Arr√™t</label>
						<input type="text" name="generation_stop_sequences" class="syn-input" value="{{ config.generationStopSequences|join(', ') }}" placeholder="Ex: \n\n, END">
					</div>
				</div>
			</div>

			<!-- ============================= CONTEXT CACHING ============================= -->
			<div class="syn-card mb-6" style="margin-bottom: 2rem;">
				<div class="syn-card-header">
					<div class="syn-kpi-icon success" style="width: 32px; height: 32px; font-size: 1rem; border-radius: 6px;">
						<i data-lucide="database"></i>
					</div>
					<div>
						<h2 style="font-size: 1.1rem; margin: 0;">Context Caching</h2>
						<p style="margin: 0; font-size: 0.9rem; color: var(--syn-text-muted);">Optimisation des co√ªts pour les contextes volumineux.</p>
					</div>
				</div>

				<div class="syn-card-body">
					<div style="background: var(--syn-bg-main); padding: 1rem; border-radius: var(--syn-radius-sm); border: 1px solid var(--syn-border); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
						<input type="checkbox" name="context_caching_enabled" id="context_caching_enabled" value="1" {{ config.isContextCachingEnabled ? 'checked' : '' }} style="width: 1.25rem; height: 1.25rem; accent-color: var(--syn-color-primary);">
						<div>
							<label for="context_caching_enabled" style="font-weight: 600; cursor: pointer; display: block;">Activer le context caching</label>
							<p style="margin: 0; font-size: 0.85rem; color: var(--syn-text-muted);">R√©utilise le contexte sans le renvoyer √† chaque requ√™te.</p>
						</div>
					</div>

					<div class="syn-alert syn-alert-info">
						<i data-lucide="info" style="flex-shrink: 0; margin-top: 2px;"></i>
						<div>
							<strong style="display: block; margin-bottom: 0.25rem;">Information Importante</strong>
							<p style="margin: 0; font-size: 0.9rem;">Min: 2,048 tokens. TTL: 1h. √âconomie ~90%.</p>
						</div>
					</div>

					<div class="syn-form-group">
						<label class="syn-label">üîë ID du Cache Vertex AI</label>
						<input type="text" name="context_caching_id" class="syn-input" value="{{ config.contextCachingId }}" placeholder="projects/..." style="font-family: monospace;">
					</div>
				</div>
			</div>

			<!-- ============================= ACTIONS ============================= -->
			<div style="position: sticky; bottom: 2rem; background: var(--syn-bg-surface); border: 1px solid var(--syn-border); padding: 1rem 2rem; border-radius: var(--syn-radius); display: flex; justify-content: flex-end; gap: 1rem; box-shadow: var(--syn-shadow-lg); z-index: 50;">
				<a href="{{ path('assistant_index') }}" class="syn-btn syn-btn-secondary">
					<i data-lucide="x"></i>
					Annuler
				</a>
				<button type="submit" class="syn-btn syn-btn-primary">
					<i data-lucide="save"></i>
					Enregistrer
				</button>
			</div>

		</form>
	</div>
{% endblock %}
