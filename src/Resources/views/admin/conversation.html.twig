{% extends '@Synapse/admin/_layout.html.twig' %}

{% block admin_content %}
<div class="page-header mb-6">
	<div class="header-content">
		<div class="flex items-center gap-3">
			<a href="{{ path('assistant_admin_risks') }}" class="btn btn-sm btn-outline">
				<i data-lucide="arrow-left" class="w-4 h-4"></i>
				Retour
			</a>
			<h1 class="text-2xl font-bold text-gray-900">Examen de Sécurité</h1>
		</div>
		<p class="text-gray-500 mt-2">
			Consultation exceptionnelle de la conversation #{{ conversation.id }}
			<span class="badge badge-warning ml-2">ACCÈS LOGUÉ</span>
		</p>
	</div>
</div>

{# Minimalist Context Strip - Bootstrap #}
<div class="card shadow-sm border-0 mb-4">
	<div
		class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3 p-4">

		{# 1. Security Status #}
		<div class="d-flex align-items-center gap-3">
			<div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center text-danger" style="width: 48px; height: 48px;">
				<i data-lucide="alert-triangle" style="width: 24px; height: 24px;"></i>
			</div>
			<div>
				<div class="text-uppercase text-muted fw-bold small">Risque détecté</div>
				<div class="d-flex align-items-center gap-2">
					<span class="fw-bold text-dark fs-5">{{ conversation.riskCategory }}</span>
					<span class="badge bg-danger">{{ conversation.riskLevel.value }}</span>
				</div>
				<div class="text-muted small">{{ conversation.updatedAt|date('d/m/Y H:i') }}</div>
			</div>
		</div>

		<div class="vr d-none d-md-block" style="height: 40px;"></div>

		{# 2. User Info #}
		<div class="d-flex align-items-center gap-3">
			{% if conversation.owner.picture %}
				<img src="{{ conversation.owner.picture }}" class="rounded-circle border" style="width: 42px; height: 42px; object-fit: cover;" alt="">
			{% else %}
				<div class="rounded-circle bg-light text-secondary fw-bold d-flex align-items-center justify-content-center border" style="width: 42px; height: 42px; font-size: 0.875rem;">
					{{ conversation.owner.firstName|first }}{{ conversation.owner.lastName|first }}
				</div>
			{% endif %}
			<div>
				<div class="fw-medium text-dark">{{ conversation.owner.firstName }}
					{{ conversation.owner.lastName }}</div>
				<div class="text-muted small">{{ conversation.owner.email }}</div>
			</div>
		</div>

		<div class="vr d-none d-md-block" style="height: 40px;"></div>

		{# 3. Actions #}
		<div>
			<button class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-2" disabled title="Bientôt disponible">
				<i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
				Clôturer
			</button>
		</div>

	</div>
</div>

{# Chat History #}
<div class="card">
	<div class="card-header border-b border-gray-100 p-4 bg-gray-50">
		<h2 class="text-lg font-semibold text-gray-800">
			{{ decrypted_title }}
		</h2>
	</div>

	<style>
		.chat-container {
			display: flex;
			flex-direction: column;
			gap: 1.5rem;
			padding: 1.5rem;
			background-color: #f8fafc; /* Slate 50 */
		}
		.chat-row {
			display: flex;
			width: 100%;
		}
		.chat-row.user {
			justify-content: flex-end;
		}
		.chat-row.model {
			justify-content: flex-start;
		}
		.chat-bubble {
			max-width: 75%;
			padding: 1rem 1.25rem;
			border-radius: 1rem;
			box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
			line-height: 1.6;
			position: relative;
		}
		.chat-bubble.user {
			background-color: #7c3aed; /* Violet 600 */
			color: white;
			border-bottom-right-radius: 0.25rem;
		}
		.chat-bubble.user .meta {
			color: rgba(255, 255, 255, 0.9);
		}
		.chat-bubble.model {
			background-color: white;
			color: #1e293b; /* Slate 800 */
			border: 1px solid #e2e8f0;
			border-bottom-left-radius: 0.25rem;
		}
		.chat-bubble.model .meta {
			color: #64748b; /* Slate 500 */
		}
		.meta {
			font-size: 0.75rem;
			font-weight: 600;
			margin-bottom: 0.5rem;
			display: block;
			text-transform: capitalize;
		}
		.prose p {
			margin-bottom: 0.75em;
		}
		.prose p:last-child {
			margin-bottom: 0;
		}
	</style>

	<div class="chat-container">
		{% for message in messages %}
			<div class="chat-row {{ message.role }}">
				<div class="chat-bubble {{ message.role }}">
					<span class="meta">
						{{ message.role == 'model' ? 'L\'Ange Gardien' : conversation.owner.firstName }} • {{ message.createdAt|date('H:i') }}
						</span>
						<div class="prose">
							{{ message.content|nl2br }}
						</div>
					</div>
				</div>
			{% else %}
				<div class="text-center py-10 text-gray-400">
					Aucun message dans cette conversation.
				</div>
			{% endfor %}
		</div>
	</div>
{% endblock %}
