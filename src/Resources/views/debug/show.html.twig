<!DOCTYPE html>
<html>
	<head>
		<title>Synapse Debug Details ({{ id }})</title>
		<style>
			body {
				font-family: system-ui, -apple-system, sans-serif;
				padding: 20px;
				background: #f9fafb;
				color: #111827;
				max-width: 1200px;
				margin: 0 auto;
			}
			h1 {
				border-bottom: 2px solid #e5e7eb;
				padding-bottom: 15px;
				margin-bottom: 30px;
			}
			h2 {
				margin-top: 40px;
				color: #374151;
				display: flex;
				align-items: center;
				gap: 8px;
				font-size: 1.25rem;
				border-bottom: 1px solid #f3f4f6;
				padding-bottom: 8px;
			}
			pre {
				background: #1f2937;
				color: #f3f4f6;
				padding: 15px;
				border-radius: 8px;
				overflow-x: auto;
				font-size: 13px;
				margin: 0;
				line-height: 1.5;
			}
			.badge {
				background: #dbeafe;
				color: #1e40af;
				padding: 2px 8px;
				border-radius: 999px;
				font-size: 12px;
				font-weight: 500;
			}

			.turn {
				background: white;
				border: 1px solid #e5e7eb;
				border-radius: 12px;
				padding: 24px;
				margin-bottom: 24px;
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
			}
			.turn-header {
				font-weight: 600;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				border-bottom: 1px solid #f3f4f6;
				padding-bottom: 12px;
			}

			.section-block {
				margin-top: 15px;
				margin-bottom: 20px;
			}
			.section-block .label {
				font-size: 0.75rem;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				color: #6b7280;
				margin-bottom: 6px;
				font-weight: 700;
			}
			.section-block.thinking .content {
				background: #fffbeb;
				border-left: 4px solid #fcd34d;
				padding: 15px;
				color: #92400e;
				white-space: pre-wrap;
				font-family: monospace;
				font-size: 0.9em;
				border-radius: 0 8px 8px 0;
			}
			.section-block.response .content {
				white-space: pre-wrap;
				line-height: 1.6;
			}

			/* Utility to extract thinking */
			{% macro render_content_with_thinking(text) %}
				{% if '<thinking>' in text %}
					{% set parts = text|split('</thinking>') %}
					{% set thinking_part = parts[0]|split('<thinking>') %}

					{% if thinking_part[1] is defined %}
						<div class="section-block thinking"> <div class="label">üß† R√©flexion (CoT)</div> <div class="content">{{thinking_part[1]|trim}}</div> </div>{% endif %}

					{% set response_text = parts[1]|default('')|trim %}
					{% if response_text is not empty %}
						<div class="section-block response"> <div class="label">üó£Ô∏è R√©ponse IA</div> <div class="content">{{response_text}}</div> </div>{% endif %}
				{% else %}
					<div class="section-block response"> <div class="label">üó£Ô∏è R√©ponse IA</div> <div class="content">{{text}}</div> </div>{% endif %}
			{% endmacro %}
		</style>
	</head>
	<body>
		<h1>‚öôÔ∏è Synapse Debug Infos
			<span style="font-size:0.5em; color: #9ca3af; font-weight:normal;">{{ id }}</span>
		</h1>

		<section style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
			<h2 style="margin-top: 0;">üìä Configuration</h2>
			<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
				<div>
					<div class="label">Mod√®le utilis√©</div>
					<div style="font-weight: 600; color: #1f2937; font-size: 1.1em;">{{ debug.model|default('Non sp√©cifi√©') }}</div>
				</div>
				<div>
					<div class="label">Endpoint</div>
					<div style="font-weight: 600; color: #1f2937; font-size: 1.1em;">
						{% if debug.endpoint == 'Vertex AI' %}
							<span style="color: #059669;">{{ debug.endpoint }}</span>
						{% else %}
							<span style="color: #dc2626;">{{ debug.endpoint|default('AI Studio') }}</span>
						{% endif %}
					</div>
				</div>
				<div>
					<div class="label">Nombre de tours</div>
					<div style="font-weight: 600; color: #1f2937; font-size: 1.1em;">{{ debug.turns|length }}</div>
				</div>
				<div>
					<div class="label">Messages en historique</div>
					<div style="font-weight: 600; color: #1f2937; font-size: 1.1em;">{{ debug.history_loaded|default('N/A') }}</div>
				</div>
			</div>
		</section>

		<section style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
			<h2 style="margin-top: 0;">üí∞ Usage (Tokens)</h2>
			{% if debug.usage is defined and debug.usage is not empty %}
				<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
					<div>
						<div class="label">Prompt Tokens (Input)</div>
						<div style="font-weight: 600; font-size: 1.1em; color: #4b5563;">{{ debug.usage.promptTokenCount|default(0) }}</div>
					</div>
					<div>
						<div class="label">Candidates Tokens (Output)</div>
						<div style="font-weight: 600; font-size: 1.1em; color: #4b5563;">{{ debug.usage.candidatesTokenCount|default(0) }}</div>
					</div>
					<div>
						<div class="label">Thoughts Tokens (CoT)</div>
						<div style="font-weight: 600; font-size: 1.1em; color: #d97706;">{{ debug.usage.thoughtsTokenCount|default(0) }}</div>
					</div>
					<div>
						<div class="label">Total Tokens</div>
						<div style="font-weight: 600; font-size: 1.1em; color: #2563eb;">{{ debug.usage.totalTokenCount|default(0) }}</div>
					</div>
				</div>
			{% else %}
				<div style="color: #6b7280; font-style: italic;">Donn√©es d'usage non disponibles</div>
			{% endif %}
		</section>

		<section style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
			<h2 style="margin-top: 0;">üõ°Ô∏è Ange Gardien (Safety)</h2>
			{% if debug.safety is defined and debug.safety is not empty %}
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
					{% for rating in debug.safety %}
						{% set isSafe = rating.probability == 'NEGLIGIBLE' or rating.probability == 'LOW' %}
						<div style="border: 1px solid #f3f4f6; padding: 10px; border-radius: 8px; border-left: 4px solid {{ isSafe ? '#10b981' : '#f59e0b' }};">
							<div class="label" style="margin-bottom: 4px;">{{ rating.category|replace({'HARM_CATEGORY_': ''})|lower|capitalize }}</div>
							<div style="font-size: 0.9em;">
								<span style="font-weight:600;">{{ rating.probability }}</span>
								{% if rating.blocked|default(false) %}
									<span style="color: #dc2626; font-weight:bold; margin-left:5px;">(BLOCKED)</span>
								{% endif %}
							</div>
						</div>
					{% endfor %}
				</div>
			{% else %}
				<div style="color: #6b7280; font-style: italic;">Aucune donn√©e de s√©curit√© retourn√©e</div>
			{% endif %}
		</section>

		<section>
			<h2>üìú Prompt Syst√®me</h2>
			<pre>{{ debug.system_prompt|default('Non disponible') }}</pre>
		</section>

		<section>
			<h2>üîÑ Historique envoy√©</h2>
			<pre>{{ debug.history|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_UNICODE')) }}</pre>
		</section>

		<section>
			<h2>‚ö° Cycles de r√©flexion ({{ debug.turns|length }}
				tours)</h2>
			{% for turn in debug.turns %}
				<div class="turn">
					<div class="turn-header">
						<span>Tour
							{{ turn.turn }}</span>
						<span>
							{% if turn.function_calls_count > 0 %}
								<span class="badge">Outils ({{ turn.function_names|join(', ') }})</span>
							{% endif %}
						</span>
					</div>

					{% if turn.function_calls_count > 0 %}
						{% for fc in turn.function_calls_data|default([]) %}
							<div class="section-block">
								<div class="label">üõ†Ô∏è Arguments Tool ({{ fc.name }})</div>
								<pre>{{ fc.args|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_UNICODE')) }}</pre>
							</div>
						{% endfor %}
					{% endif %}

					{% if turn.has_text %}
						{{ _self.render_content_with_thinking(turn.text_content) }}
					{% else %}
						<div class="content text-gray-500" style="font-style:italic; color:#9ca3af;">(Pas de contenu textuel pour ce tour)</div>
					{% endif %}
				</div>
			{% endfor %}
		</section>

		<section>
			<h2>üì° R√©ponse API Brute</h2>
			<pre>{{ debug.raw_response|default({})|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_UNICODE')) }}</pre>
		</section>
	</body>
</html>
