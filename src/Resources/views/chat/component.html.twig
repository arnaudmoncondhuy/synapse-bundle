{#
    Synapse Chat Component

    Include this template in your page:
    {{ include('@Synapse/chat/component.html.twig') }}

    Make sure Stimulus is loaded and the controller is available.
#}

{# Link the CSS (AssetMapper) #}
<link rel="stylesheet" href="{{ asset('synapse/styles/synapse.css') }}">

<div class="synapse-chat" data-controller="synapse--chat" data-synapse--chat-history-value="{{ history|default([])|json_encode|e('html_attr') }}">

    {# Header #}
    {% block synapse_header %}
        <div class="synapse-chat__header">
            <div class="synapse-chat__title">Synapse AI</div>
            <div class="synapse-chat__actions">
                {% set personas = synapse_get_personas() %}
                {% if personas is not empty %}
                    <select class="synapse-chat__persona-selector" 
                            data-synapse--chat-target="personaSelect"
                            title="Choisir une personnalitÃ©">
                        <option value="">L'Assistant (DÃ©faut)</option>
                        {% for p in personas %}
                            <option value="{{ p.key }}">{{ p.emoji }} {{ p.name }}</option>
                        {% endfor %}
                    </select>
                {% endif %}

                <button type="button" 
                        class="synapse-chat__reset-btn" 
                        data-action="click->synapse--chat#newConversation"
                        title="Nouvelle conversation">
                    ğŸ—‘ï¸
                </button>
            </div>
        </div>
    {% endblock %}

    {# Messages Container #}
    <div class="synapse-chat__messages" data-synapse--chat-target="messages">
        {% block synapse_messages_content %}
            <div class="synapse-chat__message synapse-chat__message--assistant">
                <div class="synapse-chat__avatar">
                    {% block synapse_avatar_assistant %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="synapse-chat__icon-ai"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                    {% endblock %}
                </div>
                <div class="synapse-chat__content">
                    <div class="synapse-chat__bubble">
                        <p>Bonjour ! Je suis votre assistant IA. Comment puis-je vous aider aujourd'hui ?</p>
                    </div>
                </div>
            </div>
        {% endblock %}
    </div>

    {# Input Area #}
    {% block synapse_input_area %}
        <div class="synapse-chat__input-area">
            <form data-action="submit->synapse--chat#send">
                <div class="synapse-chat__input-wrapper">
                    <textarea
                        data-synapse--chat-target="input"
                        placeholder="Posez votre question..."
                        rows="1"
                        data-action="keydown->synapse--chat#handleKeydown input->synapse--chat#autoResize"
                    ></textarea>
                    <button type="submit" data-synapse--chat-target="submitBtn">
                        Envoyer
                    </button>
                </div>
            </form>
        </div>
    {% endblock %}

</div>
