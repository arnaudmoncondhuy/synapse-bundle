{% extends '@Synapse/admin_v2/layout/base.html.twig' %}

{% block v2_page_title %}Test preset :
	{{ preset.name }}
	| Intelligence | Synapse Admin V2
{% endblock %}

{% block v2_breadcrumb %}
	<span class="sv2-topbar__breadcrumb-sep">›</span>
	<a href="#" class="sv2-topbar__breadcrumb">Intelligence</a>
	<span class="sv2-topbar__breadcrumb-sep">›</span>
	<a href="{{ path('synapse_v2_admin_presets') }}" class="sv2-topbar__breadcrumb">Presets</a>
	<span class="sv2-topbar__breadcrumb-sep">›</span>
	<span class="sv2-topbar__current">Test :
		{{ preset.name }}</span>
{% endblock %}

{% block v2_content %}

	<div class="sv2-page-header">
		<div class="sv2-page-header__info">
			<h1 class="sv2-page-title">
				<span class="sv2-page-title__icon sv2-kpi__icon--warning">
					<i data-lucide="flask-conical"></i>
				</span>
				Test du preset :
				{{ preset.name }}
			</h1>
			<p class="sv2-page-subtitle">
				Analyse en cours — le preset est testé en 3 étapes via l'agent de validation.
			</p>
		</div>
		<div class="sv2-page-header__actions">
			<a href="{{ path('synapse_v2_admin_presets') }}" class="sv2-btn sv2-btn--ghost sv2-btn--sm">
				<i data-lucide="arrow-left"></i>
				Retour aux presets
			</a>
		</div>
	</div>

	{# ── Progression ──────────────────────────────────────────────────────────── #}
	<div class="sv2-card" id="waiting-card">
		<div class="sv2-card__header">
			<div class="sv2-card__header-icon sv2-kpi__icon--warning">
				<i data-lucide="loader-2" id="spinner-icon"></i>
			</div>
			<div>
				<div class="sv2-card__title">Analyse en cours…</div>
				<div class="sv2-card__subtitle" id="status-message">Initialisation du test</div>
			</div>
		</div>
		<div class="sv2-card__body sv2-card__body--compact">
			<div class="sv2-progress sv2-mb-lg">
				<div class="sv2-progress__bar" id="progress-bar" style="width: 0%"></div>
			</div>

			<div class="sv2-grid sv2-grid--3">
				<div class="sv2-card sv2-card--hover" id="step-1">
					<div class="sv2-kpi">
						<div class="sv2-kpi__icon sv2-kpi__icon--neutral" id="step-1-icon">
							<i data-lucide="circle"></i>
						</div>
						<div class="sv2-kpi__body">
							<div class="sv2-kpi__label">Étape 1</div>
							<div class="sv2-kpi__value sv2-text-sm">Connexion provider</div>
						</div>
					</div>
				</div>
				<div class="sv2-card sv2-card--hover" id="step-2">
					<div class="sv2-kpi">
						<div class="sv2-kpi__icon sv2-kpi__icon--neutral" id="step-2-icon">
							<i data-lucide="circle"></i>
						</div>
						<div class="sv2-kpi__body">
							<div class="sv2-kpi__label">Étape 2</div>
							<div class="sv2-kpi__value sv2-text-sm">Génération LLM</div>
						</div>
					</div>
				</div>
				<div class="sv2-card sv2-card--hover" id="step-3">
					<div class="sv2-kpi">
						<div class="sv2-kpi__icon sv2-kpi__icon--neutral" id="step-3-icon">
							<i data-lucide="circle"></i>
						</div>
						<div class="sv2-kpi__body">
							<div class="sv2-kpi__label">Étape 3</div>
							<div class="sv2-kpi__value sv2-text-sm">Validation réponse</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="result-container"></div>

	<script>
		const statusUrl = '{{ path('synapse_v2_admin_presets_test_status', {id: preset.id}) }}';
let pollCount = 0;

function updateStep(stepNum, status) {
const iconEl = document.getElementById (`step-${stepNum}-icon`);
if (! iconEl) 
return;

iconEl.className = `sv2-kpi__icon sv2-kpi__icon--${
status === 'done' ? 'success' : (status === 'current' ? 'warning' : 'neutral')
}`;
iconEl.innerHTML = `<i data-lucide="${
status === 'done' ? 'check-circle-2' : (status === 'current' ? 'loader-2' : 'circle')
}"></i>`;
if (typeof lucide !== 'undefined') 
lucide.createIcons();

}

function poll() {
fetch(statusUrl).then(r => {
if (r.headers.get('content-type') ?. includes('text/html')) {
return r.text().then(html => {
document.getElementById('waiting-card').style.display = 'none';
document.getElementById('result-container').innerHTML = html;
if (typeof lucide !== 'undefined') 
lucide.createIcons();

});
}
return r.json().then(data => {
const progress = data.progress || 0;
document.getElementById('progress-bar').style.width = progress + '%';
if (data.message) 
document.getElementById('status-message').textContent = data.message;


if (progress >= 33) 
updateStep(1, 'done');
 else if (progress > 0) 
updateStep(1, 'current');

if (progress >= 66) 
updateStep(2, 'done');
 else if (progress >= 33) 
updateStep(2, 'current');

if (progress >= 100) 
updateStep(3, 'done');
 else if (progress >= 66) 
updateStep(3, 'current');


if (data.status !== 'completed' && data.status !== 'error' && pollCount < 60) {
pollCount++;
setTimeout(poll, 1500);
}
});
}).catch(() => setTimeout(poll, 2000));
}

document.addEventListener('DOMContentLoaded', () => setTimeout(poll, 800));
	</script>

{% endblock %}
