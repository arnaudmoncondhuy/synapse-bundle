<!DOCTYPE html>
<html>
	<head>
		<title>R√©sultat du test de preset - {{ report.preset.name }}</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: system-ui, -apple-system, sans-serif;
				background: #f9fafb;
				color: #111827;
				line-height: 1.6;
			}
			.container {
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
			}
			.header {
				display: flex;
				align-items: center;
				gap: 20px;
				margin-bottom: 30px;
				padding-bottom: 20px;
				border-bottom: 2px solid #e5e7eb;
			}
			.header h1 {
				flex: 1;
				font-size: 2rem;
				margin: 0;
			}
			.badge {
				padding: 8px 16px;
				border-radius: 6px;
				font-weight: 600;
				font-size: 0.95rem;
				white-space: nowrap;
			}
			.badge.success {
				background: #dcfce7;
				color: #166534;
			}
			.badge.warning {
				background: #fef3c7;
				color: #92400e;
			}
			.section {
				background: white;
				border: 1px solid #e5e7eb;
				border-radius: 8px;
				padding: 24px;
				margin-bottom: 20px;
				box-shadow: 0 1px 3px rgba(0,0,0,0.05);
			}
			.section h2 {
				font-size: 1.3rem;
				margin-bottom: 16px;
				color: #1f2937;
				border-bottom: 1px solid #e5e7eb;
				padding-bottom: 12px;
			}
			.section h3 {
				font-size: 1rem;
				margin: 16px 0 12px 0;
				color: #374151;
			}
			.ai-response {
				background: #f0fdf4;
				border-left: 4px solid #16a34a;
				padding: 16px;
				border-radius: 4px;
				margin-bottom: 16px;
				line-height: 1.7;
			}
			#analysis-rendered {
				background: #f9fafb;
				border-radius: 6px;
				padding: 16px;
				margin-bottom: 16px;
			}
			#analysis-rendered h3 {
				color: #1e40af;
				margin-top: 0;
				margin-bottom: 12px;
				font-size: 1rem;
			}
			#analysis-rendered ul {
				margin: 10px 0;
				padding-left: 24px;
			}
			#analysis-rendered li {
				margin: 6px 0;
			}
			.raw-text-section {
				margin-top: 16px;
			}
			details {
				background: #f9fafb;
				border: 1px solid #e5e7eb;
				border-radius: 6px;
				padding: 12px;
			}
			details summary {
				cursor: pointer;
				font-weight: 500;
				color: #374151;
				padding: 8px;
				user-select: none;
			}
			details summary:hover {
				color: #1f2937;
			}
			#analysis-raw {
				background: #1f2937;
				color: #f3f4f6;
				padding: 12px;
				border-radius: 4px;
				overflow-x: auto;
				font-size: 12px;
				line-height: 1.4;
				margin-top: 12px;
			}
			.usage-table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 12px;
			}
			.usage-table th,
			.usage-table td {
				padding: 10px;
				text-align: left;
				border-bottom: 1px solid #e5e7eb;
			}
			.usage-table th {
				background: #f3f4f6;
				font-weight: 600;
			}
			.actions {
				display: flex;
				gap: 12px;
				margin-top: 20px;
			}
			.btn {
				padding: 10px 16px;
				border-radius: 6px;
				border: none;
				cursor: pointer;
				font-weight: 500;
				text-decoration: none;
				display: inline-block;
				transition: all 0.2s;
			}
			.btn-primary {
				background: #1e40af;
				color: white;
			}
			.btn-primary:hover {
				background: #1e3a8a;
			}
			.btn-secondary {
				background: #e5e7eb;
				color: #111827;
			}
			.btn-secondary:hover {
				background: #d1d5db;
			}
			.critical-checks {
				margin: 12px 0;
			}
			.check-item {
				display: flex;
				align-items: center;
				gap: 8px;
				margin: 8px 0;
				padding: 8px;
				background: #f9fafb;
				border-radius: 4px;
			}
			.check-icon {
				font-size: 1.2rem;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<!-- En-t√™te -->
			<div class="header">
				<div>
					<h1>üß™ Test du preset: {{ report.preset.name }}</h1>
					<p style="color: #6b7280; margin-top: 6px;">{{ report.preset.description ?? '‚Äì' }}</p>
				</div>
				<div class="badge {% if report.all_critical_ok %}success{% else %}warning{% endif %}">
					{% if report.all_critical_ok %}
						‚úÖ SUCC√àS
					{% else %}
						‚ö†Ô∏è V√âRIFICATION REQUISE
					{% endif %}
				</div>
			</div>

			<!-- Checks critiques PHP -->
			<div class="section">
				<h2>üìã V√©rifications critiques</h2>
				<div class="critical-checks">
					<div class="check-item">
						<span class="check-icon">{% if report.critical_checks.response_not_empty %}‚úÖ{% else %}‚ùå{% endif %}</span>
						<span>La r√©ponse de l'IA n'est pas vide</span>
					</div>
					<div class="check-item">
						<span class="check-icon">{% if report.critical_checks.debug_saved_in_db %}‚úÖ{% else %}‚ùå{% endif %}</span>
						<span>Le debug est enregistr√© en base de donn√©es (ID: {{ report.debug_id ?? '‚Äì' }})</span>
					</div>
				</div>
			</div>

			<!-- R√©ponse de test de l'IA -->
			<div class="section">
				<h2>üí¨ R√©ponse du LLM au message de test</h2>
				<div class="ai-response">
					{{ report.ai_response ?? 'Pas de r√©ponse' }}
				</div>
			</div>

			<!-- Rapport d'analyse -->
			<div class="section">
				<h2>üìä Rapport d'analyse du preset</h2>
				<p style="color: #6b7280; font-size: 0.95rem; margin-bottom: 16px;">
					ü§ñ Analyse autonome des param√®tres transmis vs. configuration attendue
				</p>

				<div id="analysis-rendered"></div>

				<div class="raw-text-section">
					<details>
						<summary>üìã Texte brut (pour copier-coller)</summary>
						<pre id="analysis-raw">{{ report.analysis }}</pre>
					</details>
				</div>
			</div>

			<!-- Consommation de tokens -->
			{% if report.usage_test %}
				<div class="section">
					<h2>üìà Consommation de tokens</h2>
					<table class="usage-table">
						<tr>
							<th>M√©trique</th>
							<th>Valeur</th>
						</tr>
						<tr>
							<td>Tokens d'entr√©e</td>
							<td>{{ report.usage_test.promptTokenCount ?? 0 }}</td>
						</tr>
						<tr>
							<td>Tokens de sortie</td>
							<td>{{ report.usage_test.candidatesTokenCount ?? 0 }}</td>
						</tr>
						<tr>
							<td>Tokens de r√©flexion</td>
							<td>{{ report.usage_test.thoughtsTokenCount ?? 0 }}</td>
						</tr>
						<tr style="font-weight: 600; background: #f3f4f6;">
							<td>Total</td>
							<td>{{ report.usage_test.totalTokenCount ?? 0 }}</td>
						</tr>
					</table>
				</div>
			{% endif %}

			<!-- Actions -->
			<div class="section">
				<h2>üîó Actions</h2>
				<div class="actions">
					{% if report.debug_id %}
						<a href="{{ path('synapse_debug_show', {id: report.debug_id}) }}" class="btn btn-primary">
							üìã Voir le debug complet
						</a>
					{% endif %}
					<a href="{{ path('synapse_admin_presets') }}" class="btn btn-secondary">
						‚Üê Retour aux presets
					</a>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
		<script>
			document.addEventListener('DOMContentLoaded', function() {
				const rawText = document.getElementById('analysis-raw').textContent;
				document.getElementById('analysis-rendered').innerHTML = marked.parse(rawText);
			});
		</script>
	</body>
</html>
