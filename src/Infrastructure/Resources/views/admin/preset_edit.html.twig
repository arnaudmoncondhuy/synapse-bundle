{% extends '@Synapse/admin/layout.html.twig' %}

{% block admin_title %}{{ is_new ? 'Nouveau preset' : preset.name }} — Presets — Synapse Admin{% endblock %}

{% block admin_content %}
<div class="synapse-admin__page">
	<div class="synapse-admin__page-header">
		<div>
			<a href="{{ path('synapse_admin_presets') }}" class="synapse-admin__back-link">
				<i data-lucide="arrow-left"></i>
				Retour aux presets
			</a>
			<h1 class="synapse-admin__page-title">
				<i data-lucide="sliders-horizontal"></i>
				{{ is_new ? 'Nouveau preset' : 'Éditer : ' ~ preset.name }}
			</h1>
		</div>
	</div>

	<form method="post"
	      action="{{ is_new ? path('synapse_admin_presets_new') : path('synapse_admin_presets_edit', {id: preset.id}) }}"
	      style="display: flex; flex-direction: column; gap: 1.5rem;">

		{# ── Informations de base ──────────────────────────────────────────── #}
		<div class="synapse-admin__card">
			<div class="synapse-admin__card-body">
				<div class="synapse-admin__form-row">
					<label class="synapse-admin__label">Nom du preset <span class="synapse-admin__required">*</span></label>
					<input type="text" name="name" value="{{ preset.name }}"
					       class="synapse-admin__input" required placeholder="Ex: Gemini Flash Créatif">
				</div>
			</div>
		</div>

		{# ── Sélection Provider + Modèle ───────────────────────────────────── #}
		<div class="synapse-admin__card">
			<div class="synapse-admin__card-header">
				<span class="synapse-admin__card-title">Provider & Modèle</span>
			</div>
			<div class="synapse-admin__card-body synapse-admin__grid synapse-admin__grid--2">
				<div class="synapse-admin__form-row">
					<label class="synapse-admin__label">Provider <span class="synapse-admin__required">*</span></label>
					<select name="provider_name" id="provider-select" class="synapse-admin__select"
					        onchange="updateModelOptions(this.value)">
						{% for provider in providers %}
							<option value="{{ provider.name }}"
							        {% if provider.name == preset.providerName %}selected{% endif %}>
								{{ provider.label }}
								{% if not provider.isEnabled %}(désactivé){% endif %}
							</option>
						{% endfor %}
					</select>
				</div>
				<div class="synapse-admin__form-row">
					<label class="synapse-admin__label">Modèle <span class="synapse-admin__required">*</span></label>
					<select name="model" id="model-select" class="synapse-admin__select" onchange="updateFormVisibility()">
						{% for provider, models in models_by_provider %}
							<optgroup label="{{ provider }}" data-provider="{{ provider }}">
								{% for modelId in models %}
									<option value="{{ modelId }}"
									        data-provider="{{ provider }}"
									        {% if modelId == preset.model %}selected{% endif %}>
										{{ modelId }}
									</option>
								{% endfor %}
							</optgroup>
						{% endfor %}
					</select>
				</div>
			</div>
		</div>

		{# ── Model Capabilities Display ────────────────────────── #}
		<div class="synapse-admin__card" id="model-caps-display" style="background: rgba(0, 102, 204, 0.05); border-left: 4px solid var(--synapse-admin-primary);">
			<div class="synapse-admin__card-body" style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
				<!-- Capabilities will be populated by JS -->
			</div>
		</div>

			{# ── Paramètres de génération ──────────────────────────────────────── #}
		<div class="synapse-admin__card">
			<div class="synapse-admin__card-header">
				<span class="synapse-admin__card-title">Paramètres de génération</span>
			</div>
			<div class="synapse-admin__card-body synapse-admin__grid synapse-admin__grid--3">
				<div class="synapse-admin__form-row">
					<label class="synapse-admin__label">Température</label>
					<div class="synapse-admin__range-wrapper">
						<input type="range" name="generation_temperature"
						       min="0" max="2" step="0.1"
						       value="{{ preset.generationTemperature }}"
						       class="synapse-admin__range"
						       oninput="this.nextElementSibling.textContent = this.value">
						<span class="synapse-admin__range-value">{{ preset.generationTemperature }}</span>
					</div>
					<p class="synapse-admin__help">0 = déterministe · 2 = très créatif</p>
				</div>
				<div class="synapse-admin__form-row">
					<label class="synapse-admin__label">Top P</label>
					<div class="synapse-admin__range-wrapper">
						<input type="range" name="generation_top_p"
						       min="0" max="1" step="0.05"
						       value="{{ preset.generationTopP }}"
						       class="synapse-admin__range"
						       oninput="this.nextElementSibling.textContent = this.value">
						<span class="synapse-admin__range-value">{{ preset.generationTopP }}</span>
					</div>
				</div>
				<div class="synapse-admin__form-row" id="section-top-k">
					<label class="synapse-admin__label">Top K</label>
					<input type="number" name="generation_top_k"
					       value="{{ preset.generationTopK }}"
					       min="1" max="100"
					       class="synapse-admin__input">
					<p class="synapse-admin__help">Ignoré pour les modèles OVH.</p>
				</div>
				<div class="synapse-admin__form-row">
					<label class="synapse-admin__label">Max Output Tokens</label>
					<input type="number" name="generation_max_output_tokens"
					       value="{{ preset.generationMaxOutputTokens ?: '' }}"
					       class="synapse-admin__input"
					       placeholder="Illimité">
				</div>
				<div class="synapse-admin__form-row synapse-admin__col-span-2">
					<label class="synapse-admin__label">Séquences d'arrêt</label>
					<input type="text" name="generation_stop_sequences"
					       value="{{ preset.generationStopSequences ? preset.generationStopSequences|join(', ') : '' }}"
					       class="synapse-admin__input"
					       placeholder="Ex: \n, END, STOP (séparés par des virgules)">
				</div>
			</div>
		</div>

		{# ── Advanced Options (Collapsible) ──────────────────────── #}
		<details class="synapse-admin__details-section" id="advanced-options" open>
			<summary class="synapse-admin__details-summary">
				<i data-lucide="chevron-down" class="synapse-admin__details-chevron"></i>
				Options avancées
			</summary>

			{# ── Thinking ──────────────────────────────────────────────────────── #}
			<div class="synapse-admin__card" id="section-thinking">
				<div class="synapse-admin__card-header">
					<span class="synapse-admin__card-title">Réflexion & Reasoning</span>
				</div>
				<div class="synapse-admin__card-body synapse-admin__grid synapse-admin__grid--2">
				<div class="synapse-admin__form-row">
					<label class="synapse-admin__label">
						<input type="checkbox" name="thinking_enabled" value="1"
						       {% if preset.thinkingEnabled %}checked{% endif %}>
						Activer le thinking
					</label>
					<p class="synapse-admin__help">Gemini: réflexion interne. OVH: reasoning effort.</p>
				</div>
				<div class="synapse-admin__form-row">
					<label class="synapse-admin__label">Budget thinking (Gemini)</label>
					<input type="number" name="thinking_budget"
					       value="{{ preset.thinkingBudget }}"
					       min="128" max="24576"
					       class="synapse-admin__input">
					<p class="synapse-admin__help">0–24576 tokens alloués à la réflexion interne.</p>
				</div>
				<div class="synapse-admin__form-row">
					<label class="synapse-admin__label">Effort de reasoning (OVH)</label>
					<select name="reasoning_effort" class="synapse-admin__select">
						<option value="high" {% if preset.reasoningEffort == 'high' %}selected{% endif %}>Élevé (high)</option>
						<option value="medium" {% if preset.reasoningEffort == 'medium' %}selected{% endif %}>Moyen (medium)</option>
						<option value="low" {% if preset.reasoningEffort == 'low' %}selected{% endif %}>Faible (low)</option>
						<option value="minimal" {% if preset.reasoningEffort == 'minimal' %}selected{% endif %}>Minimal</option>
					</select>
					<p class="synapse-admin__help">OVH Gpt-oss-20b: contrôle l'effort de réflexion.</p>
				</div>
			</div>
		</div>

		{# ── Safety Settings ───────────────────────────────────────────────── #}
		<div class="synapse-admin__card" id="section-safety">
			<div class="synapse-admin__card-header">
				<span class="synapse-admin__card-title">Filtres de sécurité (Gemini)</span>
			</div>
			<div class="synapse-admin__card-body">
				<div class="synapse-admin__form-row" style="margin-bottom: 1rem">
					<label class="synapse-admin__label">
						<input type="checkbox" name="safety_enabled" value="1"
						       {% if preset.safetyEnabled %}checked{% endif %}>
						Activer les filtres de sécurité
					</label>
				</div>
				<div class="synapse-admin__grid synapse-admin__grid--3">
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Seuil par défaut</label>
						<select name="safety_default_threshold" class="synapse-admin__select">
							{% for value, label in safety_thresholds %}
								<option value="{{ value }}" {% if preset.safetyDefaultThreshold == value %}selected{% endif %}>{{ label }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Hate Speech</label>
						<select name="safety_hate_speech" class="synapse-admin__select">
							<option value="">Par défaut</option>
							{% for value, label in safety_thresholds %}
								<option value="{{ value }}" {% if preset.safetyHateSpeech == value %}selected{% endif %}>{{ label }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Dangerous Content</label>
						<select name="safety_dangerous_content" class="synapse-admin__select">
							<option value="">Par défaut</option>
							{% for value, label in safety_thresholds %}
								<option value="{{ value }}" {% if preset.safetyDangerousContent == value %}selected{% endif %}>{{ label }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Harassment</label>
						<select name="safety_harassment" class="synapse-admin__select">
							<option value="">Par défaut</option>
							{% for value, label in safety_thresholds %}
								<option value="{{ value }}" {% if preset.safetyHarassment == value %}selected{% endif %}>{{ label }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Sexually Explicit</label>
						<select name="safety_sexually_explicit" class="synapse-admin__select">
							<option value="">Par défaut</option>
							{% for value, label in safety_thresholds %}
								<option value="{{ value }}" {% if preset.safetySexuallyExplicit == value %}selected{% endif %}>{{ label }}</option>
							{% endfor %}
						</select>
					</div>
				</div>
			</div>
		</div>

		{# ── Streaming Mode (Debug) ────────────────────────────────────────── #}
		<div class="synapse-admin__card" id="section-streaming">
			<div class="synapse-admin__card-header">
				<span class="synapse-admin__card-title">Mode Streaming</span>
			</div>
			<div class="synapse-admin__card-body">
				<div class="synapse-admin__form-row" style="margin-bottom: 1rem">
					<label class="synapse-admin__label">
						<input type="checkbox" name="streaming_enabled" value="1"
						       {% if preset.streamingEnabled %}checked{% endif %}>
						Activer le streaming (SSE)
					</label>
					<p style="color: #6b7280; font-size: 12px; margin-top: 0.5rem;">
						✓ Par défaut: réponses en temps réel (chunks SSE)<br/>
						✗ Désactivé: mode synchrone - réponse complète d'un coup (mieux pour le debug)
					</p>
				</div>
			</div>
		</div>
		</details>


		<div class="synapse-admin__sticky-save">
			<button type="submit" class="synapse-admin__btn synapse-admin__btn--primary">
				<i data-lucide="save"></i>
				{{ is_new ? 'Créer le preset' : 'Enregistrer les modifications' }}
			</button>
			<a href="{{ path('synapse_admin_presets') }}" class="synapse-admin__btn synapse-admin__btn--ghost">
				Annuler
			</a>
		</div>
	</form>
</div>

<script>
const modelCapabilities = {{ model_capabilities|json_encode|raw }};

function updateModelOptions(providerName) {
	const select = document.getElementById('model-select');
	const optgroups = select.querySelectorAll('optgroup');

	optgroups.forEach(group => {
		const isMatch = group.dataset.provider === providerName;
		group.style.display = isMatch ? '' : 'none';
	});

	// Auto-select first option of provider if current model is not from this provider
	const currentModelId = select.value;
	if (!modelCapabilities[currentModelId] || modelCapabilities[currentModelId].provider !== providerName) {
		for (const opt of select.querySelectorAll('option')) {
			if (opt.dataset.provider === providerName) {
				select.value = opt.value;
				break;
			}
		}
	}
	
	updateFormVisibility();
}

function updateFormVisibility() {
	const modelId = document.getElementById('model-select').value;
	const caps = modelCapabilities[modelId] || {
		thinking: false,
		safety_settings: false,
		top_k: true
	};

	const sections = {
		'section-thinking': caps.thinking,
		'section-safety': caps.safety_settings,
		'section-top-k': caps.top_k
	};

	for (const [id, visible] of Object.entries(sections)) {
		const el = document.getElementById(id);
		if (el) {
			el.style.display = visible ? '' : 'none';
			
			// Si la section contient des champs obligatoires désactivés, on enlève le 'required' pour ne pas bloquer le form
			const inputs = el.querySelectorAll('input, select, textarea');
			inputs.forEach(input => {
				if (!visible) {
					// On ne touche pas au disabled, juste on cache, et le contrôleur PHP ignorera les valeurs de toute façon
					// Mais on s'assure de ne pas envoyer un required caché
					if (input.hasAttribute('required')) {
						input.dataset.wasRequired = 'true';
						input.removeAttribute('required');
					}
				} else {
					if (input.dataset.wasRequired === 'true') {
						input.setAttribute('required', 'required');
					}
				}
			});
		}
	}

	// Update capability badges
	updateCapsBadges(modelId, caps);
}

function updateCapsBadges(modelId, caps) {
	const displayEl = document.getElementById('model-caps-display');
	if (!displayEl) return;

	const body = displayEl.querySelector('.synapse-admin__card-body');
	if (!body) return;

	// Clear existing badges
	body.innerHTML = '';

	// Add capability badges
	const capabilities = [
		{ key: 'thinking', label: 'Thinking', icon: 'brain' },
		{ key: 'function_calling', label: 'Tool Calls', icon: 'wrench' },
		{ key: 'safety_settings', label: 'Safety Filters', icon: 'shield' },
		{ key: 'streaming', label: 'Streaming', icon: 'activity' }
	];

	let hasCapabilities = false;
	for (const { key, label, icon } of capabilities) {
		const capKey = key === 'function_calling' ? 'functionCalling' :
		               key === 'safety_settings' ? 'safetySettings' : key;

		if (caps[capKey]) {
			const pill = document.createElement('span');
			pill.className = 'synapse-admin__capability-pill synapse-admin__capability-pill--active';
			pill.innerHTML = `<i data-lucide="${icon}" style="width: 14px; height: 14px;"></i> ${label}`;
			body.appendChild(pill);
			hasCapabilities = true;
		}
	}

	if (!hasCapabilities) {
		body.innerHTML = '<p style="margin: 0; color: var(--synapse-admin-text-secondary); font-size: 0.9rem;">Aucune capacité spéciale pour ce modèle</p>';
	} else if (typeof lucide !== 'undefined') {
		lucide.createIcons();
	}
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
	const providerSelect = document.getElementById('provider-select');
	const modelSelect = document.getElementById('model-select');

	providerSelect.addEventListener('change', (e) => updateModelOptions(e.target.value));
	modelSelect.addEventListener('change', () => updateFormVisibility());

	updateModelOptions(providerSelect.value);
	updateFormVisibility();
});
</script>
{% endblock %}
