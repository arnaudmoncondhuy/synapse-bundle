{% extends '@Synapse/admin/layout.html.twig' %}

{% block admin_title %}
	{{ provider.label }}
	— Providers — Synapse Admin
{% endblock %}

{% block admin_content %}
	<div class="synapse-admin__page">
		<div class="synapse-admin__page-header">
			<div>
				<a href="{{ path('synapse_admin_providers') }}" class="synapse-admin__back-link">
					<i data-lucide="arrow-left"></i>
					Retour aux providers
				</a>
				<h1 class="synapse-admin__page-title">
					<i data-lucide="plug"></i>
					{{ provider.label }}
				</h1>
			</div>
		</div>

		<form method="post" action="{{ path('synapse_admin_providers_edit', {id: provider.id}) }}">
			<div class="synapse-admin__card">
				<div class="synapse-admin__card-header">
					<span class="synapse-admin__card-title">Informations générales</span>
				</div>
				<div class="synapse-admin__card-body">
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Nom affiché</label>
						<input type="text" name="label" value="{{ provider.label }}" class="synapse-admin__input" required>
					</div>
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">
							<input type="checkbox" name="is_enabled" value="1" {% if provider.isEnabled %} checked {% endif %}>
							Provider activé
						</label>
						<p class="synapse-admin__help">Un provider désactivé ne peut pas être utilisé dans les presets.</p>
					</div>
				</div>
			</div>

			{# ── Credentials dynamiques ────────────────────────────────────────── #}
			{% if fields is defined and fields is not empty %}
				<div class="synapse-admin__card">
					<div class="synapse-admin__card-header">
						<span class="synapse-admin__card-title">Configuration des accès</span>
					</div>
					<div class="synapse-admin__card-body">
						{% set creds = provider.credentials %}
						{% for name, config in fields %}
							<div class="synapse-admin__form-row">
								<label class="synapse-admin__label">
									{{ config.label }}
									{% if config.required|default(false) %}
										<span class="synapse-admin__required">*</span>
									{% endif %}
								</label>

								{% if config.type == 'select' %}
									<select name="{{ name }}" class="synapse-admin__select" {% if config.required|default(false) %} required {% endif %}>
										{% for value, label in config.options %}
											<option value="{{ value }}" {% if creds[name]|default(config.value|default('')) == value %} selected {% endif %}>
												{{ label }}
											</option>
										{% endfor %}
									</select>
								{% elseif config.type == 'textarea' %}
									<textarea name="{{ name }}" class="synapse-admin__textarea {% if config.is_code|default(false) %}synapse-admin__textarea--code{% endif %}" rows="8" placeholder="{{ config.placeholder|default('') }}" {% if config.required|default(false) and creds[name] is empty %} required {% endif %}></textarea>
									{% if creds[name] is not empty %}
										<p class="synapse-admin__help">
											<i data-lucide="shield-check"></i>
											Valeur déjà configurée. Laissez vide pour conserver, ou remplissez pour modifier.
										</p>
									{% endif %}
								{% elseif config.type == 'password' %}
									<input type="password" name="{{ name }}" class="synapse-admin__input" placeholder="{% if creds[name] is not empty %}Valeur configurée — laisser vide pour conserver{% else %}{{ config.placeholder|default('') }}{% endif %}" {% if config.required|default(false) and creds[name] is empty %} required {% endif %}>
								{% else %}
									<input type="text" name="{{ name }}" value="{{ creds[name]|default(config.value|default('')) }}" class="synapse-admin__input" placeholder="{{ config.placeholder|default('') }}" {% if config.required|default(false) %} required {% endif %}>
								{% endif %}

								{% if config.help is defined %}
									<p class="synapse-admin__help">{{ config.help|raw }}</p>
								{% endif %}
							</div>
						{% endfor %}
					</div>
				</div>

				{# ── Fallback (JSON brut) ───────────────────────────────────────────── #}
			{% else %}
				<div class="synapse-admin__card">
					<div class="synapse-admin__card-header">
						<span class="synapse-admin__card-title">Credentials (JSON)</span>
					</div>
					<div class="synapse-admin__card-body">
						<div class="synapse-admin__form-row">
							<label class="synapse-admin__label">Données JSON</label>
							<textarea name="credentials_raw" class="synapse-admin__textarea synapse-admin__textarea--code" rows="10">{{ provider.credentials|json_encode(constant('JSON_PRETTY_PRINT')) }}</textarea>
						</div>
					</div>
				</div>
			{% endif %}

			<div class="synapse-admin__form-actions">
				<button type="submit" class="synapse-admin__btn synapse-admin__btn--primary">
					<i data-lucide="save"></i>
					Enregistrer
				</button>
				<a href="{{ path('synapse_admin_providers') }}" class="synapse-admin__btn synapse-admin__btn--ghost">
					Annuler
				</a>
			</div>
		</form>
	</div>
{% endblock %}
