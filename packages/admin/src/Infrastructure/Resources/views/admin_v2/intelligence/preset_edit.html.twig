{% extends '@Synapse/admin_v2/layout/base.html.twig' %}

{% block v2_page_title %}
	{{ is_new ? 'Nouveau preset' : 'Ã‰diter : ' ~ preset.name }}
	| Intelligence | Synapse Admin V2
{% endblock %}

{% block v2_breadcrumb %}
	<span class="sv2-topbar__breadcrumb-sep">â€º</span>
	<a href="{{ path('synapse_v2_admin_configuration_llm') }}" class="sv2-topbar__breadcrumb">Intelligence</a>
	<span class="sv2-topbar__breadcrumb-sep">â€º</span>
	<a href="{{ path('synapse_v2_admin_configuration_llm', {tab: 'presets'}) }}" class="sv2-topbar__breadcrumb">Presets</a>
	<span class="sv2-topbar__breadcrumb-sep">â€º</span>
	<span class="sv2-topbar__current">{{ is_new ? 'Nouveau' : preset.name }}</span>
{% endblock %}

{% block v2_content %}

	{# â”€â”€ En-tÃªte â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
	<div class="sv2-page-header">
		<div class="sv2-page-header__info">
			<h1 class="sv2-page-title">
				<span class="sv2-page-title__icon sv2-kpi__icon--primary">
					<i data-lucide="sliders-horizontal"></i>
				</span>
				{{ is_new ? 'Nouveau preset LLM' : 'Ã‰diter : ' ~ preset.name }}
			</h1>
			<p class="sv2-page-subtitle">
				{{ is_new
                ? 'Configurez un nouveau profil de gÃ©nÃ©ration (provider, modÃ¨le, paramÃ¨tres).'
                : 'Modifiez ce profil de gÃ©nÃ©ration LLM. Les changements sont appliquÃ©s immÃ©diatement aprÃ¨s sauvegarde.'
            }}
			</p>
		</div>
		<div class="sv2-page-header__actions">
			<a href="{{ path('synapse_v2_admin_configuration_llm', {tab: 'presets'}) }}" class="sv2-btn sv2-btn--ghost sv2-btn--sm">
				<i data-lucide="arrow-left"></i>
				Retour
			</a>
			{% if not is_new %}
				<form method="post" action="{{ path('synapse_v2_admin_presets_test', {id: preset.id}) }}" style="display:inline">
					<button type="submit" class="sv2-btn sv2-btn--outline sv2-btn--sm">
						<i data-lucide="flask-conical"></i>
						Tester ce preset
					</button>
				</form>
			{% endif %}
		</div>
	</div>

	{# â”€â”€ Formulaire â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
	<form method="post" id="preset-form" action="{{ is_new ? path('synapse_v2_admin_presets_new') : path('synapse_v2_admin_presets_edit', {id: preset.id}) }}" onsubmit="syncProviderOptionsBeforeSubmit()">

		<input
		type="hidden" name="_token" value="{{ csrf_token('synapse_v2_preset_edit') }}">

		{# â”€â”€ Nom du preset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
		<div class="sv2-card sv2-mb-lg">
			<div class="sv2-card__header">
				<div class="sv2-card__header-icon sv2-kpi__icon--primary">
					<i data-lucide="tag"></i>
				</div>
				<div>
					<div class="sv2-card__title">Identification</div>
					<div class="sv2-card__subtitle">Nom interne du preset</div>
				</div>
			</div>
			<div class="sv2-card__body sv2-card__body--compact">
				<div class="sv2-form-group">
					<label class="sv2-label" for="preset-name">
						Nom du preset
						<span class="sv2-required">*</span>
					</label>
					<input type="text" id="preset-name" name="name" value="{{ preset.name }}" class="sv2-input" required placeholder="Ex: Gemini Flash CrÃ©atif">
				</div>
			</div>
		</div>

		{# â”€â”€ Provider & ModÃ¨le â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
		<div class="sv2-card sv2-mb-lg">
			<div class="sv2-card__header">
				<div class="sv2-card__header-icon sv2-kpi__icon--primary">
					<i data-lucide="plug"></i>
				</div>
				<div>
					<div class="sv2-card__title">Provider & ModÃ¨le</div>
					<div class="sv2-card__subtitle">Source et modÃ¨le de gÃ©nÃ©ration</div>
				</div>
			</div>
			<div class="sv2-card__body sv2-card__body--compact">
				<div class="sv2-grid sv2-grid--2">
					<div class="sv2-form-group">
						<label class="sv2-label" for="provider-select">
							Provider
							<span class="sv2-required">*</span>
						</label>
						<select name="provider_name" id="provider-select" class="sv2-select" onchange="updateModelOptions(this.value); renderDynamicFields(this.value)">
							{% for provider in providers %}
								<option value="{{ provider.name }}" {% if provider.name == preset.providerName %} selected {% endif %}>
									{{ provider.label }}
									{% if not provider.isEnabled %}(dÃ©sactivÃ©)
									{% endif %}
								</option>
							{% endfor %}
						</select>
					</div>
					<div class="sv2-form-group">
						<label class="sv2-label" for="model-select">
							ModÃ¨le
							<span class="sv2-required">*</span>
						</label>
						<select name="model" id="model-select" class="sv2-select" onchange="updateFormVisibility()">
							{% for provider, models in models_by_provider %}
								<optgroup label="{{ provider }}" data-provider="{{ provider }}">
									{% for modelId in models %}
										<option value="{{ modelId }}" data-provider="{{ provider }}" {% if modelId == preset.model %} selected {% endif %}>
											{{ modelId }}
										</option>
									{% endfor %}
								</optgroup>
							{% endfor %}
						</select>
					</div>
				</div>
			</div>
		</div>

		{# â”€â”€ CapacitÃ©s du modÃ¨le (JS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
		<div class="sv2-card sv2-mb-lg" id="model-caps-display">
			<div
				class="sv2-card__body sv2-card__body--compact sv2-flex sv2-gap-sm sv2-flex-wrap">{# Rempli par JS dynamiquement #}
			</div>
		</div>

		{# â”€â”€ ParamÃ¨tres de gÃ©nÃ©ration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
		<div class="sv2-card sv2-mb-lg" id="generation-params-card">
			<div class="sv2-card__header">
				<div class="sv2-card__header-icon sv2-kpi__icon--neutral">
					<i data-lucide="settings-2"></i>
				</div>
				<div>
					<div class="sv2-card__title">ParamÃ¨tres de gÃ©nÃ©ration</div>
					<div class="sv2-card__subtitle">ContrÃ´le de la crÃ©ativitÃ© et des limites de sortie</div>
				</div>
			</div>
			<div class="sv2-card__body sv2-card__body--compact">
				<div class="sv2-grid sv2-grid--3">

					<div class="sv2-form-group">
						<label class="sv2-label">TempÃ©rature</label>
						<div class="sv2-range-wrapper">
							<input type="range" name="generation_temperature" min="0" max="2" step="0.1" value="{{ preset.generationTemperature }}" class="sv2-range" oninput="this.nextElementSibling.textContent = this.value">
							<span class="sv2-range-value">{{ preset.generationTemperature }}</span>
						</div>
						<p class="sv2-help">0 = dÃ©terministe Â· 2 = trÃ¨s crÃ©atif</p>
					</div>

					<div class="sv2-form-group">
						<label class="sv2-label">Top P</label>
						<div class="sv2-range-wrapper">
							<input type="range" name="generation_top_p" min="0" max="1" step="0.05" value="{{ preset.generationTopP }}" class="sv2-range" oninput="this.nextElementSibling.textContent = this.value">
							<span class="sv2-range-value">{{ preset.generationTopP }}</span>
						</div>
					</div>

					<div class="sv2-form-group" id="section-top-k">
						<label class="sv2-label">Top K</label>
						<input type="number" name="generation_top_k" value="{{ preset.generationTopK }}" min="1" max="100" class="sv2-input">
						<p class="sv2-help">ParamÃ¨tre de filtrage pour certains modÃ¨les.</p>
					</div>

					<div class="sv2-form-group">
						<label class="sv2-label">Max Output Tokens</label>
						<input type="number" name="generation_max_output_tokens" value="{{ preset.generationMaxOutputTokens ?: '' }}" class="sv2-input" placeholder="IllimitÃ©">
					</div>

					<div class="sv2-form-group sv2-col-span-2">
						<label class="sv2-label">SÃ©quences d'arrÃªt</label>
						<input type="text" name="generation_stop_sequences" value="{{ preset.generationStopSequences ? preset.generationStopSequences|join(', ') : '' }}" class="sv2-input" placeholder="Ex: \\n, END, STOP (sÃ©parÃ©s par des virgules)">
					</div>

				</div>
			</div>
		</div>

		{# â”€â”€ Mode Streaming â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
		<div class="sv2-card sv2-mb-lg" id="transmission-mode-card">
			<div class="sv2-card__header">
				<div class="sv2-card__header-icon sv2-kpi__icon--info">
					<i data-lucide="activity"></i>
				</div>
				<div>
					<div class="sv2-card__title">Mode de transmission</div>
					<div class="sv2-card__subtitle">Streaming SSE ou rÃ©ponse synchrone</div>
				</div>
			</div>
			<div class="sv2-card__body sv2-card__body--compact">
				<label class="sv2-toggle">
					<input type="checkbox" name="streaming_enabled" value="1" {% if preset.streamingEnabled %} checked {% endif %}>
					<span class="sv2-toggle__label">Activer le streaming (SSE)</span>
				</label>
				<p class="sv2-help sv2-mt-sm">
					âœ“ ActivÃ© : rÃ©ponses en temps rÃ©el (chunks SSE) Â·
					                âœ— DÃ©sactivÃ© : mode synchrone, mieux pour le debug
				</p>
			</div>
		</div>

		{# â”€â”€ Options Provider (champs dynamiques JS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
		<div class="sv2-card sv2-mb-lg" id="provider-options-card">
			<div class="sv2-card__header">
				<div class="sv2-card__header-icon sv2-kpi__icon--warning">
					<i data-lucide="sliders-horizontal"></i>
				</div>
				<div>
					<div class="sv2-card__title">Options du provider</div>
					<div class="sv2-card__subtitle">Configuration dynamique (thinking, safety, etc.)</div>
				</div>
			</div>
			<div class="sv2-card__body sv2-card__body--compact">
				<div
					id="dynamic-provider-ui" class="sv2-grid sv2-grid--2 sv2-gap-lg">{# Champs injectÃ©s par JS #}
				</div>
			</div>
		</div>

		{# â”€â”€ JSON AvancÃ© (source de vÃ©ritÃ©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
		<div class="sv2-card sv2-mb-xl" id="provider-options-json-card">
			<div class="sv2-card__header">
				<div class="sv2-card__header-icon sv2-kpi__icon--neutral">
					<i data-lucide="code-2"></i>
				</div>
				<div>
					<div class="sv2-card__title">JSON avancÃ©</div>
					<div class="sv2-card__subtitle">Source de vÃ©ritÃ© synchronisÃ©e avec les champs ci-dessus</div>
				</div>
			</div>
			<div class="sv2-card__body sv2-card__body--compact">
				<div class="sv2-form-group">
					<label class="sv2-label" for="provider-options-json">providerOptions (JSON)</label>
					<textarea id="provider-options-json" name="provider_options_json" class="sv2-input sv2-font-mono" rows="12" style="font-size: 12px; min-height: 200px;">{{ preset.providerOptions ? preset.providerOptions|json_encode(constant('JSON_PRETTY_PRINT')) : '{}' }}</textarea>
					<p class="sv2-help sv2-mt-sm">
						ğŸ’¡ Ã‰dition directe du JSON. Les changements aux champs dynamiques mettent Ã  jour ce champ automatiquement.
					</p>
					<p class="sv2-help sv2-mt-xs sv2-text-warning">
						âš ï¸ Syntaxe JSON invalide = sauvegarde refusÃ©e.
					</p>
				</div>
				<input type="hidden" name="provider_options" id="provider-options-hidden" value="{{ preset.providerOptions ? preset.providerOptions|json_encode : '{}' }}">
			</div>
		</div>

		{# â”€â”€ Actions de sauvegarde â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
		<div class="sv2-sticky-actions">
			<button type="submit" class="sv2-btn sv2-btn--primary">
				<i data-lucide="save"></i>
				{{ is_new ? 'CrÃ©er le preset' : 'Enregistrer les modifications' }}
			</button>
			<a href="{{ path('synapse_v2_admin_configuration_llm', {tab: 'presets'}) }}" class="sv2-btn sv2-btn--ghost">
				Annuler
			</a>
		</div>

	</form>

	{# â”€â”€ JS identique au V1 â€” Provider options dynamiques â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
	<script>
		const modelCapabilities = {{ model_capabilities|json_encode|raw }};

const PROVIDER_SCHEMAS = {
'gemini': {
fields: [
{
name: 'thinking.enabled',
type: 'checkbox',
label: 'Activer le thinking',
help: 'RÃ©flexion interne approfondie',
capability: 'thinking'
},
{
name: 'thinking.budget',
type: 'number',
label: 'Budget de rÃ©flexion (tokens)',
help: '128â€“24576 tokens allouÃ©s Ã  la rÃ©flexion',
min: 128,
max: 24576,
defaultValue: 1024,
dependsOn: 'thinking.enabled'
},
{
name: 'safety_settings.enabled',
type: 'checkbox',
label: 'Activer les filtres de sÃ©curitÃ©',
help: 'Active les filtres de contenu inappropriÃ©',
capability: 'safetySettings'
},
{
name: 'safety_settings.default_threshold',
type: 'select',
label: 'Seuil de sÃ©curitÃ© par dÃ©faut',
help: 'Niveau de filtrage par dÃ©faut',
options: [
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
}, {
value: 'BLOCK_ONLY_HIGH',
label: 'Bloquer haute probabilitÃ©'
}, {
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Bloquer moyenne et haute'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Bloquer toute probabilitÃ©'
}
],
defaultValue: 'BLOCK_MEDIUM_AND_ABOVE',
dependsOn: 'safety_settings.enabled'
}, {
name: 'safety_settings.thresholds.hate_speech',
type: 'select',
label: 'Discours haineux',
help: 'Seuil spÃ©cifique',
options: [
{
value: '',
label: 'Non dÃ©fini'
},
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
},
{
value: 'BLOCK_ONLY_HIGH',
label: 'Haute'
},
{
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Moyenne+'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Toute'
}
],
dependsOn: 'safety_settings.enabled'
}, {
name: 'safety_settings.thresholds.dangerous_content',
type: 'select',
label: 'Contenu dangereux',
help: 'Seuil spÃ©cifique',
options: [
{
value: '',
label: 'Non dÃ©fini'
},
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
},
{
value: 'BLOCK_ONLY_HIGH',
label: 'Haute'
},
{
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Moyenne+'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Toute'
}
],
dependsOn: 'safety_settings.enabled'
}, {
name: 'safety_settings.thresholds.harassment',
type: 'select',
label: 'HarcÃ¨lement',
help: 'Seuil spÃ©cifique',
options: [
{
value: '',
label: 'Non dÃ©fini'
},
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
},
{
value: 'BLOCK_ONLY_HIGH',
label: 'Haute'
},
{
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Moyenne+'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Toute'
}
],
dependsOn: 'safety_settings.enabled'
}, {
name: 'safety_settings.thresholds.sexually_explicit',
type: 'select',
label: 'Contenu explicite',
help: 'Seuil spÃ©cifique',
options: [
{
value: '',
label: 'Non dÃ©fini'
},
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
},
{
value: 'BLOCK_ONLY_HIGH',
label: 'Haute'
},
{
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Moyenne+'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Toute'
}
],
dependsOn: 'safety_settings.enabled'
}
]
},
'ovh': {
fields: [
{
name: 'thinking.enabled',
type: 'checkbox',
label: 'Activer le thinking',
help: 'Raisonnement approfondi',
capability: 'thinking'
}, {
name: 'thinking.reasoning_effort',
type: 'select',
label: "Niveau d'effort",
help: 'IntensitÃ© du raisonnement',
options: [
{
value: 'low',
label: 'Faible'
}, {
value: 'medium',
label: 'Moyen'
}, {
value: 'high',
label: 'Ã‰levÃ©'
}
],
defaultValue: 'high',
dependsOn: 'thinking.enabled'
}
]
}
};

function renderDynamicFields(providerName) {
const container = document.getElementById('dynamic-provider-ui');
if (! container) 
return;

container.innerHTML = '';
const modelId = document.getElementById('model-select').value;
const caps = modelCapabilities[modelId] || {};
let schema = PROVIDER_SCHEMAS[providerName];
const card = document.getElementById('provider-options-card');
const jsonCard = document.getElementById('provider-options-json-card');
if (! schema || ! schema.fields) {
if (card) 
card.style.display = 'none';

if (jsonCard) 
jsonCard.style.display = 'none';

return;
}
const jsonTextarea = document.getElementById('provider-options-json');
let currentData = {};
try {
currentData = JSON.parse(jsonTextarea.value || '{}');
} catch (e) {}
const hiddenField = document.getElementById('provider-options-hidden');
if (hiddenField && jsonTextarea) 
hiddenField.value = jsonTextarea.value;

const excludedCapabilities = [];
schema.fields.forEach(f => {
if (f.capability && ! caps[f.capability]) 
excludedCapabilities.push(f.name);

});
schema.fields.forEach(fieldDef => {
if (fieldDef.capability && ! caps[fieldDef.capability]) 
return;

if (fieldDef.dependsOn && excludedCapabilities.includes(fieldDef.dependsOn)) 
return;

const value = getNestedValue(currentData, fieldDef.name);
const isChecked = value === true || value === 'true';
const fieldValue = value !== undefined ? value : fieldDef.defaultValue;
const fieldEl = document.createElement('div');
fieldEl.className = 'sv2-form-group';
fieldEl.id = `field-${
fieldDef.name.replace(/\./g, '-')
}`;
fieldEl.innerHTML = renderField(fieldDef, fieldValue, isChecked);
fieldEl.setAttribute('data-field-name', fieldDef.name);
if (fieldDef.dependsOn) 
fieldEl.setAttribute('data-depends-on', fieldDef.dependsOn);

container.appendChild(fieldEl);
const input = fieldEl.querySelector('input, select');
if (input) {
input.addEventListener('change', () => {
updateJsonFromFields();
updateFieldVisibility();
});
input.addEventListener('input', () => updateJsonFromFields());
}
});
if (card) {
const hasFields = container.children.length > 0;
card.style.display = hasFields ? '' : 'none';
if (jsonCard) 
jsonCard.style.display = hasFields ? '' : 'none';

}
updateFieldVisibility();
}

function renderField(fieldDef, value, isChecked) {
let inputHtml = '';
if (fieldDef.type === 'checkbox') {
inputHtml = `<input type="checkbox" id="field-${
fieldDef.name
}" data-field-name="${
fieldDef.name
}" class="sv2-checkbox" ${
isChecked ? 'checked' : ''
}>`;
} else if (fieldDef.type === 'number') {
inputHtml = `<input type="number" id="field-${
fieldDef.name
}" data-field-name="${
fieldDef.name
}" value="${
value || fieldDef.defaultValue || ''
}" min="${
fieldDef.min || 0
}" max="${
fieldDef.max || ''
}" class="sv2-input">`;
} else if (fieldDef.type === 'select') {
const opts = fieldDef.options.map(
o => `<option value="${
o.value
}" ${
o.value === value ? 'selected' : ''
}>${
o.label
}</option>`
).join('');
inputHtml = `<select id="field-${
fieldDef.name
}" data-field-name="${
fieldDef.name
}" class="sv2-select">${opts}</select>`;
}
return `<label class="sv2-label" for="field-${
fieldDef.name
}">${
fieldDef.label
}</label>${inputHtml}<p class="sv2-help">${
fieldDef.help
}</p>`;
}

function updateJsonFromFields() {
const container = document.getElementById('dynamic-provider-ui');
const jsonTextarea = document.getElementById('provider-options-json');
const hiddenField = document.getElementById('provider-options-hidden');
let data = {};
try {
data = JSON.parse(jsonTextarea.value || '{}');
} catch (e) {}container.querySelectorAll('[data-field-name]').forEach(fieldRow => {
const input = fieldRow.querySelector('input, select');
if (! input) 
return;

let value = input.type === 'checkbox' ? input.checked : input.value;
if (input.type === 'number' && value) 
value = parseInt(value, 10);

setNestedValue(data, fieldRow.dataset.fieldName, value);
});
const jsonString = JSON.stringify(data, null, 2);
jsonTextarea.value = jsonString;
hiddenField.value = JSON.stringify(data);
}

function updateFieldVisibility() {
const container = document.getElementById('dynamic-provider-ui');
container.querySelectorAll('[data-depends-on]').forEach(fieldEl => {
const dependsOn = fieldEl.dataset.dependsOn;
const parentFieldRow = container.querySelector (`[data-field-name="${dependsOn}"]`);
if (! parentFieldRow) 
return;

const parentInput = parentFieldRow.querySelector('input, select');
if (! parentInput) 
return;

fieldEl.style.display = (parentInput.type === 'checkbox' ? parentInput.checked : !! parentInput.value) ? '' : 'none';
});
}

function getNestedValue(obj, path) {
return path.split('.').reduce((cur, prop) => cur ?. [prop], obj);
}
function setNestedValue(obj, path, value) {
const keys = path.split('.');
let cur = obj;
for (let i = 0; i < keys.length - 1; i++) {
if (!(keys[i] in cur) || typeof cur[keys[i]] !== 'object') 
cur[keys[i]] = {};

cur = cur[keys[i]];
}
cur[keys[keys.length - 1]] = value;
}

function syncProviderOptionsBeforeSubmit() {
const jsonTextarea = document.getElementById('provider-options-json');
const hiddenField = document.getElementById('provider-options-hidden');
try {
hiddenField.value = JSON.stringify(JSON.parse(jsonTextarea.value || '{}'));
return true;
} catch (e) {
alert('âŒ Erreur JSON :\n' + e.message);
return false;
}
}

function updateModelOptions(providerName) {
const select = document.getElementById('model-select');
select.querySelectorAll('optgroup').forEach(g => {
g.style.display = g.dataset.provider === providerName ? '' : 'none';
});
const currentModelId = select.value;
if (! modelCapabilities[currentModelId] || modelCapabilities[currentModelId].provider !== providerName) {
for (const opt of select.querySelectorAll('option')) {
if (opt.dataset.provider === providerName) {
select.value = opt.value;
break;
}
}
}
updateFormVisibility();
}

function updateFormVisibility() {
const modelId = document.getElementById('model-select').value;
const caps = modelCapabilities[modelId] || {
topK: true
};
const el = document.getElementById('section-top-k');
if (el) 
el.style.display = caps.topK ? '' : 'none';

updateCapsBadges(modelId, caps);
}

function updateCapsBadges(modelId, caps) {
const displayEl = document.getElementById('model-caps-display');
if (! displayEl) 
return;

const body = displayEl.querySelector('.sv2-card__body');
if (! body) 
return;

body.innerHTML = '';
const capabilities = [
{
key: 'thinking',
label: 'Thinking',
icon: 'brain'
}, {
key: 'functionCalling',
label: 'Tool Calls',
icon: 'wrench'
}, {
key: 'safetySettings',
label: 'Safety Filters',
icon: 'shield'
}, {
key: 'streaming',
label: 'Streaming',
icon: 'activity'
}
];
let has = false;
for (const {key, label, icon}
of capabilities) {
if (caps[key]) {
const pill = document.createElement('span');
pill.className = 'sv2-badge sv2-badge--success';
pill.innerHTML = `<i data-lucide="${icon}"></i> ${label}`;
body.appendChild(pill);
has = true;
}
}
if (! has) 
body.innerHTML = '<p class="sv2-text-sm sv2-text-muted">Aucune capacitÃ© spÃ©ciale</p>';
 else if (typeof lucide !== 'undefined') 
lucide.createIcons();

}

document.addEventListener('DOMContentLoaded', () => {
const providerSelect = document.getElementById('provider-select');
const modelSelect = document.getElementById('model-select');
providerSelect.addEventListener('change', e => {
updateModelOptions(e.target.value);
renderDynamicFields(e.target.value);
});
modelSelect.addEventListener('change', () => {
updateFormVisibility();
renderDynamicFields(providerSelect.value);
});
const jsonTextarea = document.getElementById('provider-options-json');
if (jsonTextarea) 
jsonTextarea.addEventListener('change', () => renderDynamicFields(providerSelect.value));

updateModelOptions(providerSelect.value);
updateFormVisibility();
renderDynamicFields(providerSelect.value);
});
	</script>

{% endblock %}
