{% extends '@Synapse/admin/layout.html.twig' %}

{% block admin_title %}Analytique - Synapse Admin
{% endblock %}

{% block admin_content %}
	<header class="synapse-admin__page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
		<div>
			<h1 class="synapse-admin__title">Analytique</h1>
			<div class="synapse-admin__subtitle">
				Usage et Coûts :
				{{ period_label }}
			</div>
		</div>
		<div style="display: flex; gap: 0.5rem;">
			<a href="{{ path('synapse_admin_analytics', {period: 7}) }}" class="synapse-admin__btn synapse-admin__btn--sm {% if period == 7 %}synapse-admin__btn--primary{% else %}synapse-admin__btn--outline{% endif %}">
				7j
			</a>
			<a href="{{ path('synapse_admin_analytics', {period: 30}) }}" class="synapse-admin__btn synapse-admin__btn--sm {% if period == 30 %}synapse-admin__btn--primary{% else %}synapse-admin__btn--outline{% endif %}">
				30j
			</a>
			<a href="{{ path('synapse_admin_analytics', {period: 90}) }}" class="synapse-admin__btn synapse-admin__btn--sm {% if period == 90 %}synapse-admin__btn--primary{% else %}synapse-admin__btn--outline{% endif %}">
				3 mois
			</a>
		</div>
	</header>

	{# KPIs #}
	<div
		class="synapse-admin__grid synapse-admin__grid--4" style="margin-bottom: 2rem;">
		{# Cost #}
		<div class="synapse-admin__card synapse-admin__card--hover" style="padding: 1.5rem;">
			<div class="synapse-admin__kpi">
				<div class="synapse-admin__kpi-icon synapse-admin__kpi-icon--primary">
					<i data-lucide="coins"></i>
				</div>
				<div>
					<div class="synapse-admin__kpi-label">Coût estimé</div>
					<div class="synapse-admin__kpi-value">€{{ cost|number_format(3, '.', ',') }}</div>
				</div>
			</div>
		</div>

		{# Total Tokens #}
		<div class="synapse-admin__card synapse-admin__card--hover" style="padding: 1.5rem;">
			<div class="synapse-admin__kpi">
				<div class="synapse-admin__kpi-icon synapse-admin__kpi-icon--warning">
					<i data-lucide="cpu"></i>
				</div>
				<div>
					<div class="synapse-admin__kpi-label">Total Tokens</div>
					<div class="synapse-admin__kpi-value">{{ (stats.total_tokens|default(0) / 1000)|number_format(1) }}k</div>
					<div class="synapse-admin__kpi-sub">
						<span style="color: var(--synapse-admin-success);">{{ stats.total_tokens > 0 ? ((stats.completion_tokens|default(0) / stats.total_tokens) * 100)|number_format(0) : 0 }}%</span>
						Output
					</div>
				</div>
			</div>
		</div>

		{# Requests #}
		<div class="synapse-admin__card synapse-admin__card--hover" style="padding: 1.5rem;">
			<div class="synapse-admin__kpi">
				<div class="synapse-admin__kpi-icon synapse-admin__kpi-icon--success">
					<i data-lucide="zap"></i>
				</div>
				<div>
					<div class="synapse-admin__kpi-label">Requêtes IA</div>
					<div class="synapse-admin__kpi-value">{{ stats.request_count|default(0) }}</div>
				</div>
			</div>
		</div>

		{# Thinking Tokens #}
		<div class="synapse-admin__card synapse-admin__card--hover" style="padding: 1.5rem;">
			<div class="synapse-admin__kpi">
				<div class="synapse-admin__kpi-icon synapse-admin__kpi-icon--primary">
					<i data-lucide="brain"></i>
				</div>
				<div>
					<div class="synapse-admin__kpi-label">Thinking Tokens</div>
					<div class="synapse-admin__kpi-value">{{ (stats.thinking_tokens|default(0) / 1000)|number_format(1) }}k</div>
				</div>
			</div>
		</div>
	</div>

	{# Daily Usage - Full Width #}
	<div class="synapse-admin__card" style="margin-bottom: 2rem;">
		<div class="synapse-admin__card-header">
			<h3 style="margin: 0; font-size: 1.1rem;">Usage Quotidien (30 derniers jours)</h3>
		</div>
		<div style="padding: 1.5rem;">
			{% if daily is not empty %}
				{% set max_tokens = 0 %}
				{% for day in daily %}
					{% if day.total_tokens > max_tokens %}
						{% set max_tokens = day.total_tokens %}
					{% endif %}
				{% endfor %}

				<div style="display: flex; flex-direction: column; gap: 0.75rem;">
					{% for day in daily %}
						{% set bar_width = max_tokens > 0 ? (day.total_tokens / max_tokens * 100) : 0 %}
						<div style="display: flex; align-items: center; gap: 1rem;">
							<div style="width: 80px; font-size: 0.85rem; color: var(--synapse-admin-text-muted); font-family: monospace;">{{ day.date }}</div>
							<div style="flex: 1; height: 24px; background: var(--synapse-admin-border-light); border-radius: 4px; overflow: hidden; position: relative;">
								<div style="width: {{ bar_width }}%; height: 100%; background: var(--synapse-admin-primary-light); border-right: 2px solid var(--synapse-admin-primary);"></div>
							</div>
							<div style="width: 60px; text-align: right; font-size: 0.85rem; font-weight: 600;">
								{{ (day.total_tokens / 1000)|number_format(1) }}k
							</div>
						</div>
					{% endfor %}
				</div>
			{% else %}
				<div style="text-align: center; padding: 2rem; color: var(--synapse-admin-text-muted);">Aucune donnée d'usage</div>
			{% endif %}
		</div>
	</div>

	{# Two Column Layout: Usage by Module + Usage by Model #}
	<div
		class="synapse-admin__grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
		{# Usage by Module #}
		<div class="synapse-admin__card">
			<div class="synapse-admin__card-header">
				<h3 style="margin: 0; font-size: 1.1rem;">Usage par Module</h3>
			</div>
			<div class="synapse-admin__table-container">
				<table class="synapse-admin__table">
					<thead>
						<tr>
							<th>Module</th>
							<th style="text-align: right;">Requêtes</th>
							<th style="text-align: right;">Tokens</th>
						</tr>
					</thead>
					<tbody>
						{% for module, data in usage_by_module %}
							<tr>
								<td style="font-weight: 600; text-transform: capitalize;">{{ module }}</td>
								<td style="text-align: right; color: var(--synapse-admin-text-muted);">{{ data.count|default(0) }}</td>
								<td style="text-align: right; font-family: monospace;">{{ (data.total_tokens|default(0) / 1000)|number_format(1) }}k</td>
							</tr>
						{% else %}
							<tr>
								<td colspan="3" style="padding: 2rem; text-align: center; color: var(--synapse-admin-text-muted);">Aucune donnée</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>

		{# Usage by Model #}
		<div class="synapse-admin__card">
			<div class="synapse-admin__card-header">
				<h3 style="margin: 0; font-size: 1.1rem;">Usage par Modèle</h3>
			</div>
			<div class="synapse-admin__table-container">
				<table class="synapse-admin__table">
					<thead>
						<tr>
							<th>Modèle</th>
							<th style="text-align: right;">Requêtes</th>
							<th style="text-align: right;">Tokens</th>
						</tr>
					</thead>
					<tbody>
						{% for model, data in usage_by_model %}
							<tr>
								<td>
									<code style="font-size: 0.85rem;">{{ model }}</code>
								</td>
								<td style="text-align: right; color: var(--synapse-admin-text-muted);">{{ data.count|default(0) }}</td>
								<td style="text-align: right; font-family: monospace;">{{ (data.total_tokens|default(0) / 1000)|number_format(1) }}k</td>
							</tr>
						{% else %}
							<tr>
								<td colspan="3" style="padding: 2rem; text-align: center; color: var(--synapse-admin-text-muted);">Aucune donnée</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>

	{# Automated Tasks & Conversations & Embeddings #}
	<div
		class="synapse-admin__grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;">
		{# Automated Tasks #}
		<div class="synapse-admin__card">
			<div class="synapse-admin__card-header">
				<h3 style="margin: 0; font-size: 1.1rem;">Tâches automatisées</h3>
			</div>
			<div class="synapse-admin__table-container">
				<table class="synapse-admin__table">
					<thead>
						<tr>
							<th>Module / Action</th>
							<th style="text-align: right;">Exec.</th>
							<th style="text-align: right;">Tokens</th>
						</tr>
					</thead>
					<tbody>
						{% for task in automated_stats %}
							<tr>
								<td>
									<div style="font-weight: 600; text-transform:capitalize;">{{ task.module }}</div>
									<div style="font-size: 0.8rem; color: var(--synapse-admin-text-muted);">{{ task.action }}</div>
								</td>
								<td style="text-align: right; color: var(--synapse-admin-text-muted);">{{ task.count }}</td>
								<td style="text-align: right; font-family: monospace;">{{ (task.total_tokens|default(0) / 1000)|number_format(1) }}k</td>
							</tr>
						{% else %}
							<tr>
								<td colspan="3" style="padding: 2rem; text-align: center; color: var(--synapse-admin-text-muted);">Aucune tâche automatisée</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>

		{# Conversations Stats #}
		<div class="synapse-admin__card">
			<div class="synapse-admin__card-header">
				<h3 style="margin: 0; font-size: 1.1rem;">Chat (Messages)</h3>
			</div>
			<div style="padding: 1.5rem; display: flex; align-items: center; justify-content: space-around; flex-wrap: wrap; gap: 1rem;">
				<div style="text-align: center;">
					<div class="synapse-admin__kpi-value" style="color: var(--synapse-admin-primary);">{{ conversation_stats.count|default(0) }}</div>
					<div class="synapse-admin__kpi-label">Messages</div>
				</div>
				<div style="text-align: center;">
					<div class="synapse-admin__kpi-value">{{ (conversation_stats.total_tokens|default(0) / 1000)|number_format(1) }}k</div>
					<div class="synapse-admin__kpi-label">Tokens</div>
				</div>
				<div style="text-align: center;">
					{% set conv_percentage = stats.total_tokens > 0 ? (conversation_stats.total_tokens|default(0) / stats.total_tokens * 100) : 0 %}
					<div class="synapse-admin__kpi-value" style="color: var(--synapse-admin-success);">{{ conv_percentage|number_format(0) }}%</div>
					<div class="synapse-admin__kpi-label">Budget</div>
				</div>
			</div>
		</div>

		{# Embeddings Stats #}
		<div class="synapse-admin__card">
			<div class="synapse-admin__card-header">
				<h3 style="margin: 0; font-size: 1.1rem;">Embeddings (Vecteurs)</h3>
			</div>
			<div style="padding: 1.5rem; display: flex; align-items: center; justify-content: space-around; flex-wrap: wrap; gap: 1rem;">
				<div style="text-align: center;">
					<div class="synapse-admin__kpi-value" style="color: var(--synapse-admin-primary);">{{ embedding_stats.count|default(0) }}</div>
					<div class="synapse-admin__kpi-label">Requêtes</div>
				</div>
				<div style="text-align: center;">
					<div class="synapse-admin__kpi-value">{{ (embedding_stats.total_tokens|default(0) / 1000)|number_format(1) }}k</div>
					<div class="synapse-admin__kpi-label">Tokens</div>
				</div>
				<div style="text-align: center;">
					{% set emb_percentage = stats.total_tokens > 0 ? (embedding_stats.total_tokens|default(0) / stats.total_tokens * 100) : 0 %}
					<div class="synapse-admin__kpi-value" style="color: var(--synapse-admin-success);">{{ emb_percentage|number_format(0) }}%</div>
					<div class="synapse-admin__kpi-label">Budget</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
