{% extends '@Synapse/admin/layout.html.twig' %}

{% block admin_title %}
	{{ is_new ? 'Nouveau preset' : preset.name }}
	â€” Presets â€” Synapse Admin
{% endblock %}

{% block admin_content %}
	<div class="synapse-admin__page">
		<div class="synapse-admin__page-header">
			<div>
				<a href="{{ path('synapse_admin_presets') }}" class="synapse-admin__back-link">
					<i data-lucide="arrow-left"></i>
					Retour aux presets
				</a>
				<h1 class="synapse-admin__page-title">
					<i data-lucide="sliders-horizontal"></i>
					{{ is_new ? 'Nouveau preset' : 'Ã‰diter : ' ~ preset.name }}
				</h1>
			</div>
		</div>

		<form
			method="post" id="preset-form" action="{{ is_new ? path('synapse_admin_presets_new') : path('synapse_admin_presets_edit', {id: preset.id}) }}" style="display: flex; flex-direction: column; gap: 1.5rem;" onsubmit="syncProviderOptionsBeforeSubmit()">

			{# â”€â”€ Informations de base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
			<div class="synapse-admin__card">
				<div class="synapse-admin__card-body">
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Nom du preset
							<span class="synapse-admin__required">*</span>
						</label>
						<input type="text" name="name" value="{{ preset.name }}" class="synapse-admin__input" required placeholder="Ex: Gemini Flash CrÃ©atif">
					</div>
				</div>
			</div>

			{# â”€â”€ SÃ©lection Provider + ModÃ¨le â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
			<div class="synapse-admin__card">
				<div class="synapse-admin__card-header">
					<span class="synapse-admin__card-title">Provider & ModÃ¨le</span>
				</div>
				<div class="synapse-admin__card-body synapse-admin__grid synapse-admin__grid--2">
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Provider
							<span class="synapse-admin__required">*</span>
						</label>
						<select name="provider_name" id="provider-select" class="synapse-admin__select" onchange="updateModelOptions(this.value); renderDynamicFields(this.value)">
							{% for provider in providers %}
								<option value="{{ provider.name }}" {% if provider.name == preset.providerName %} selected {% endif %}>
									{{ provider.label }}
									{% if not provider.isEnabled %}(dÃ©sactivÃ©)
									{% endif %}
								</option>
							{% endfor %}
						</select>
					</div>
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">ModÃ¨le
							<span class="synapse-admin__required">*</span>
						</label>
						<select name="model" id="model-select" class="synapse-admin__select" onchange="updateFormVisibility()">
							{% for provider, models in models_by_provider %}
								<optgroup label="{{ provider }}" data-provider="{{ provider }}">
									{% for modelId in models %}
										<option value="{{ modelId }}" data-provider="{{ provider }}" {% if modelId == preset.model %} selected {% endif %}>
											{{ modelId }}
										</option>
									{% endfor %}
								</optgroup>
							{% endfor %}
						</select>
					</div>
				</div>
			</div>

			{# â”€â”€ ParamÃ¨tres de gÃ©nÃ©ration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
			<div class="synapse-admin__card" id="generation-params-card">
				<div class="synapse-admin__card-header">
					<span class="synapse-admin__card-title">ParamÃ¨tres de gÃ©nÃ©ration</span>
				</div>
				<div class="synapse-admin__card-body synapse-admin__grid synapse-admin__grid--3">
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">TempÃ©rature</label>
						<div class="synapse-admin__range-wrapper">
							<input type="range" name="generation_temperature" min="0" max="2" step="0.1" value="{{ preset.generationTemperature }}" class="synapse-admin__range" oninput="this.nextElementSibling.textContent = this.value">
							<span class="synapse-admin__range-value">{{ preset.generationTemperature }}</span>
						</div>
						<p class="synapse-admin__help">0 = dÃ©terministe Â· 2 = trÃ¨s crÃ©atif</p>
					</div>
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Top P</label>
						<div class="synapse-admin__range-wrapper">
							<input type="range" name="generation_top_p" min="0" max="1" step="0.05" value="{{ preset.generationTopP }}" class="synapse-admin__range" oninput="this.nextElementSibling.textContent = this.value">
							<span class="synapse-admin__range-value">{{ preset.generationTopP }}</span>
						</div>
					</div>
					<div class="synapse-admin__form-row" id="section-top-k">
						<label class="synapse-admin__label">Top K</label>
						<input type="number" name="generation_top_k" value="{{ preset.generationTopK }}" min="1" max="100" class="synapse-admin__input">
						<p class="synapse-admin__help">ParamÃ¨tre de filtrage pour certains modÃ¨les.</p>
					</div>
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">Max Output Tokens</label>
						<input type="number" name="generation_max_output_tokens" value="{{ preset.generationMaxOutputTokens ?: '' }}" class="synapse-admin__input" placeholder="IllimitÃ©">
					</div>
					<div class="synapse-admin__form-row synapse-admin__col-span-2">
						<label class="synapse-admin__label">SÃ©quences d'arrÃªt</label>
						<input type="text" name="generation_stop_sequences" value="{{ preset.generationStopSequences ? preset.generationStopSequences|join(', ') : '' }}" class="synapse-admin__input" placeholder="Ex: \n, END, STOP (sÃ©parÃ©s par des virgules)">
					</div>
				</div>
			</div>

			{# â”€â”€ Model Capabilities Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
			<div class="synapse-admin__card" id="model-caps-display" style="background: rgba(0, 102, 204, 0.05); border-left: 4px solid var(--synapse-admin-primary);">
				<div class="synapse-admin__card-body" style="display: flex; gap: 0.75rem; flex-wrap: wrap;"><!-- Capabilities will be populated by JS --></div>
			</div>

			{# â”€â”€ Mode Streaming â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
			<div class="synapse-admin__card" id="transmission-mode-card">
				<div class="synapse-admin__card-header">
					<span class="synapse-admin__card-title">Mode de Transmission</span>
				</div>
				<div class="synapse-admin__card-body">
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">
							<input type="checkbox" name="streaming_enabled" value="1" {% if preset.streamingEnabled %} checked {% endif %}>
							Activer le streaming (SSE)
						</label>
						<p style="color: #6b7280; font-size: 12px; margin-top: 0.5rem;">
							âœ“ Par dÃ©faut: rÃ©ponses en temps rÃ©el (chunks SSE)<br/>
							âœ— DÃ©sactivÃ©: mode synchrone - rÃ©ponse complÃ¨te d'un coup (mieux pour le debug)
						</p>
					</div>
				</div>
			</div>

			{# â”€â”€ Provider Options (Champs Dynamiques) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
			<div class="synapse-admin__card" id="provider-options-card">
				<div class="synapse-admin__card-header">
					<span class="synapse-admin__card-title">
						<i data-lucide="sliders-horizontal" style="width: 16px; height: 16px;"></i>
						Options du Provider
					</span>
				</div>
				<div class="synapse-admin__card-body">
					<p class="synapse-admin__help" style="margin-bottom: 1.5rem;">
						Configuration dynamique basÃ©e sur le provider sÃ©lectionnÃ©.
																																																																																																																							Les changements sont synchronisÃ©s automatiquement avec le JSON avancÃ© ci-dessous.
					</p>
					{# Conteneur pour champs dynamiques gÃ©nÃ©rÃ©s par JS #}
					<div
						id="dynamic-provider-ui" class="synapse-admin__grid synapse-admin__grid--2" style="gap: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;"><!-- Champs dynamiques injectÃ©s ici par JavaScript -->
					</div>
				</div>
			</div>

			{# â”€â”€ Provider Options (JSON AvancÃ© - Source de VÃ©ritÃ©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
			<div class="synapse-admin__card" id="provider-options-json-card">
				<div class="synapse-admin__card-header">
					<span class="synapse-admin__card-title">
						<i data-lucide="code" style="width: 16px; height: 16px;"></i>
						JSON AvancÃ© (Source de VÃ©ritÃ©)
					</span>
				</div>
				<div class="synapse-admin__card-body">
					<p class="synapse-admin__help" style="margin-bottom: 1rem;">
						<strong>Champ cachÃ© et synchronisÃ© automatiquement.</strong>
						Les champs dynamiques ci-dessus mettent Ã  jour ce JSON en temps rÃ©el.
																																																																																																																							Vous pouvez aussi Ã©diter directement le JSON pour des configurations avancÃ©es.
					</p>
					<div class="synapse-admin__form-row">
						<label class="synapse-admin__label">providerOptions (JSON)
							<span class="synapse-admin__required">*</span>
						</label>
						<textarea id="provider-options-json" name="provider_options_json" class="synapse-admin__input" rows="14" required style="font-family: 'Monaco', 'Courier New', monospace; font-size: 12px; min-height: 300px;">{{ preset.providerOptions ? preset.providerOptions|json_encode(192) : '{}' }}</textarea>
						<p class="synapse-admin__help" style="color: #6b7280; margin-top: 0.5rem;">
							ğŸ’¡ Ã‰dition directe du JSON. Les changements aux champs dynamiques mettent Ã  jour ce champ automatiquement.
						</p>
						<p class="synapse-admin__help" style="color: #d97706; margin-top: 0.25rem;">
							âš ï¸ Syntaxe JSON invalide = sauvegarde refusÃ©e.
						</p>
					</div>
					{# Champ cachÃ© pour transmission au serveur #}
					<input type="hidden" name="provider_options" id="provider-options-hidden" value="{{ preset.providerOptions ? preset.providerOptions|json_encode : '{}' }}">
				</div>
			</div>

			<div class="synapse-admin__sticky-save">
				<button type="submit" class="synapse-admin__btn synapse-admin__btn--primary">
					<i data-lucide="save"></i>
					{{ is_new ? 'CrÃ©er le preset' : 'Enregistrer les modifications' }}
				</button>
				<a href="{{ path('synapse_admin_presets') }}" class="synapse-admin__btn synapse-admin__btn--ghost">
					Annuler
				</a>
			</div>
		</form>
	</div>

	<script>
		const modelCapabilities = {{ model_capabilities|json_encode|raw }};

// â”€â”€ PROVIDER SCHEMAS (dÃ©finition des champs dynamiques par provider) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROVIDER_SCHEMAS = {
'gemini': {
fields: [
{
name: 'thinking.enabled',
type: 'checkbox',
label: 'Activer le thinking',
help: 'Activation de la rÃ©flexion interne approfondie',
capability: 'thinking'
},
{
name: 'thinking.budget',
type: 'number',
label: 'Budget de rÃ©flexion (tokens)',
help: '0â€“24576 tokens allouÃ©s Ã  la rÃ©flexion',
min: 128,
max: 24576,
defaultValue: 1024,
dependsOn: 'thinking.enabled'
},
{
name: 'safety_settings.enabled',
type: 'checkbox',
label: 'Activer les filtres de sÃ©curitÃ©',
help: 'Active les filtres de contenu inappropriÃ©',
capability: 'safetySettings'
},
{
name: 'safety_settings.default_threshold',
type: 'select',
label: 'Seuil de sÃ©curitÃ© par dÃ©faut',
help: 'Niveau de filtrage par dÃ©faut',
options: [
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
}, {
value: 'BLOCK_ONLY_HIGH',
label: 'Bloquer haute probabilitÃ©'
}, {
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Bloquer moyenne et haute'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Bloquer toute probabilitÃ©'
}
],
defaultValue: 'BLOCK_MEDIUM_AND_ABOVE',
dependsOn: 'safety_settings.enabled'
}, {
name: 'safety_settings.thresholds.hate_speech',
type: 'select',
label: 'Filtre - Discours haineux',
help: 'Seuil pour les contenus haineux',
options: [
{
value: '',
label: 'Non dÃ©fini'
},
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
},
{
value: 'BLOCK_ONLY_HIGH',
label: 'Bloquer haute probabilitÃ©'
},
{
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Bloquer moyenne et haute'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Bloquer toute probabilitÃ©'
}
],
dependsOn: 'safety_settings.enabled'
}, {
name: 'safety_settings.thresholds.dangerous_content',
type: 'select',
label: 'Filtre - Contenu dangereux',
help: 'Seuil pour les contenus dangereux',
options: [
{
value: '',
label: 'Non dÃ©fini'
},
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
},
{
value: 'BLOCK_ONLY_HIGH',
label: 'Bloquer haute probabilitÃ©'
},
{
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Bloquer moyenne et haute'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Bloquer toute probabilitÃ©'
}
],
dependsOn: 'safety_settings.enabled'
}, {
name: 'safety_settings.thresholds.harassment',
type: 'select',
label: 'Filtre - HarcÃ¨lement',
help: 'Seuil pour les contenus harcelants',
options: [
{
value: '',
label: 'Non dÃ©fini'
},
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
},
{
value: 'BLOCK_ONLY_HIGH',
label: 'Bloquer haute probabilitÃ©'
},
{
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Bloquer moyenne et haute'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Bloquer toute probabilitÃ©'
}
],
dependsOn: 'safety_settings.enabled'
}, {
name: 'safety_settings.thresholds.sexually_explicit',
type: 'select',
label: 'Filtre - Contenu explicite',
help: 'Seuil pour les contenus explicites',
options: [
{
value: '',
label: 'Non dÃ©fini'
},
{
value: 'BLOCK_NONE',
label: 'Aucun filtre'
},
{
value: 'BLOCK_ONLY_HIGH',
label: 'Bloquer haute probabilitÃ©'
},
{
value: 'BLOCK_MEDIUM_AND_ABOVE',
label: 'Bloquer moyenne et haute'
}, {
value: 'BLOCK_LOW_AND_ABOVE',
label: 'Bloquer toute probabilitÃ©'
}
],
dependsOn: 'safety_settings.enabled'
}
]
},
'gemini-embedding': {
fields: [
{
name: 'output_dimensionality',
type: 'number',
label: 'Dimension de sortie',
help: 'Nombre de dimensions pour le vecteur (optionnel pour certain modÃ¨les)',
min: 1,
max: 3072,
defaultValue: 768
}
]
},
'ovh': {
fields: [
{
name: 'thinking.enabled',
type: 'checkbox',
label: 'Activer le thinking',
help: 'Activation de la rÃ©flexion/raisonnement',
capability: 'thinking'
}, {
name: 'thinking.reasoning_effort',
type: 'select',
label: 'Niveau d\'effort de rÃ©flexion',
help: 'IntensitÃ© du raisonnement',
options: [
{
value: 'low',
label: 'Faible (low)'
}, {
value: 'medium',
label: 'Moyen (medium)'
}, {
value: 'high',
label: 'Ã‰levÃ© (high)'
}
],
defaultValue: 'high',
dependsOn: 'thinking.enabled'
}
]
}
// Ajoute d'autres providers au besoin
};

// â”€â”€ GÃ‰NÃ‰RATEUR DE CHAMPS DYNAMIQUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDynamicFields(providerName) {
const container = document.getElementById('dynamic-provider-ui');
if (! container) 
return;



container.innerHTML = '';

const modelId = document.getElementById('model-select').value;
const caps = modelCapabilities[modelId] || {};

let schema = PROVIDER_SCHEMAS[providerName];
const card = document.getElementById('provider-options-card');
const jsonCard = document.getElementById('provider-options-json-card');

if (! schema || ! schema.fields) {
if (card) 
card.style.display = 'none';



if (jsonCard) 
jsonCard.style.display = 'none';



container.innerHTML = '<p style="color: #9ca3af;">Aucun paramÃ¨tre spÃ©cifique pour ce provider.</p>';
return;
}

// Parser les donnÃ©es existantes du JSON
const jsonTextarea = document.getElementById('provider-options-json');
let currentData = {};
try {
currentData = JSON.parse(jsonTextarea.value || '{}');
} catch (e) {
currentData = {};
}

// Synchronisation du champ cachÃ© Ã  l'initialisation
const hiddenField = document.getElementById('provider-options-hidden');
if (hiddenField && jsonTextarea) {
hiddenField.value = jsonTextarea.value;
}
// GÃ©nÃ©rer les champs

// PrÃ©-filtrage: identifier les champs parents qui sont exclus par capacitÃ©
const excludedCapabilities = [];
schema.fields.forEach(fieldDef => {
if (fieldDef.capability && ! caps[fieldDef.capability]) {
excludedCapabilities.push(fieldDef.name);
}
});

schema.fields.forEach(fieldDef => { // VÃ©rification de la capacitÃ© propre au champ
if (fieldDef.capability && ! caps[fieldDef.capability]) {
return; // Masquer si le modÃ¨le ne supporte pas
}

// VÃ©rification de la dÃ©pendance: si le champ dÃ©pend d'un parent exclu, on l'exclut aussi
if (fieldDef.dependsOn && excludedCapabilities.includes(fieldDef.dependsOn)) {
return; // Le parent n'est pas supportÃ©, l'enfant non plus
}

const value = getNestedValue(currentData, fieldDef.name);
const isChecked = value === true || value === 'true';
const fieldValue = value !== undefined ? value : fieldDef.defaultValue;

const fieldHtml = renderField(fieldDef, fieldValue, isChecked);
const fieldEl = document.createElement('div');
fieldEl.className = 'synapse-admin__form-row';
fieldEl.id = `field-${
fieldDef.name.replace(/\./g, '-')
}`;
fieldEl.innerHTML = fieldHtml;
fieldEl.setAttribute('data-field-name', fieldDef.name);
if (fieldDef.dependsOn) {
fieldEl.setAttribute('data-depends-on', fieldDef.dependsOn);
}

container.appendChild(fieldEl);

// Ajouter les listeners
const input = fieldEl.querySelector('input, select');
if (input) {
input.addEventListener('change', () => {
updateJsonFromFields();
updateFieldVisibility();
});
input.addEventListener('input', () => {
updateJsonFromFields();
});
}
});

// GÃ©rer la visibilitÃ© du cadre global
if (card) {
const hasVisibleFields = container.children.length > 0;
card.style.display = hasVisibleFields ? '' : 'none';
if (jsonCard) 
jsonCard.style.display = hasVisibleFields ? '' : 'none';



}

// Initialiser la visibilitÃ© des champs dÃ©pendants
updateFieldVisibility();
}

function renderField(fieldDef, value, isChecked) {
let inputHtml = '';

if (fieldDef.type === 'checkbox') {
inputHtml = `
			<input type="checkbox"
				   id="field-${
fieldDef.name
}"
				   data-field-name="${
fieldDef.name
}"
				   ${
isChecked ? 'checked' : ''
}>
		`;
} else if (fieldDef.type === 'number') {
inputHtml = `
			<input type="number"
				   id="field-${
fieldDef.name
}"
				   data-field-name="${
fieldDef.name
}"
				   value="${
value || fieldDef.defaultValue || ''
}"
				   min="${
fieldDef.min || 0
}"
				   max="${
fieldDef.max || ''
}"
				   class="synapse-admin__input">
		`;
} else if (fieldDef.type === 'select') {
const options = fieldDef.options.map(opt => `<option value="${
opt.value
}" ${
opt.value === value ? 'selected' : ''
}>${
opt.label
}</option>`).join('');
inputHtml = `
			<select id="field-${
fieldDef.name
}"
					data-field-name="${
fieldDef.name
}"
					class="synapse-admin__select">
				${options}
			</select>
		`;
}

return `
		<label class="synapse-admin__label" for="field-${
fieldDef.name
}">
			${
fieldDef.label
}
		</label>
		${inputHtml}
		<p class="synapse-admin__help">${
fieldDef.help
}</p>
	`;
}

// â”€â”€ SYNCHRONISATION HTML â†” JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateJsonFromFields() {
const container = document.getElementById('dynamic-provider-ui');
const jsonTextarea = document.getElementById('provider-options-json');
const hiddenField = document.getElementById('provider-options-hidden');

// Parser le JSON actuel
let data = {};
try {
data = JSON.parse(jsonTextarea.value || '{}');
} catch (e) {
data = {};
}

// Mettre Ã  jour depuis les champs
container.querySelectorAll('[data-field-name]').forEach(fieldRow => {
const input = fieldRow.querySelector('input, select');
if (! input) 
return;



const fieldName = fieldRow.dataset.fieldName;
let value;

if (input.type === 'checkbox') {
value = input.checked;
} else {
value = input.value;
// Convertir en nombre si type number
if (input.type === 'number' && value) {
value = parseInt(value, 10);
}
} setNestedValue(data, fieldName, value);
});

// Mettre Ã  jour les textareas
const jsonString = JSON.stringify(data, null, 2);
jsonTextarea.value = jsonString;
hiddenField.value = JSON.stringify(data);
}

function updateFieldVisibility() {
const container = document.getElementById('dynamic-provider-ui');

container.querySelectorAll('[data-depends-on]').forEach(fieldEl => {
const dependsOn = fieldEl.dataset.dependsOn;
if (! dependsOn) 
return;



const parentFieldRow = container.querySelector (`[data-field-name="${dependsOn}"]`);
if (! parentFieldRow) 
return;



const parentInput = parentFieldRow.querySelector('input, select');
if (! parentInput) 
return;



const isVisible = parentInput.type === 'checkbox' ? parentInput.checked : !! parentInput.value;
fieldEl.style.display = isVisible ? '' : 'none';
});
}

// â”€â”€ UTILITAIRES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getNestedValue(obj, path) {
return path.split('.').reduce((current, prop) => current ?. [prop], obj);
}

function setNestedValue(obj, path, value) {
const keys = path.split('.');
let current = obj;

for (let i = 0; i < keys.length - 1; i++) {
const key = keys[i];
if (!(key in current) || typeof current[key] !== 'object') {
current[key] = {};
}
current = current[key];
}

current[keys[keys.length - 1]] = value;
}

// â”€â”€ VALIDATION & SOUMISSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncProviderOptionsBeforeSubmit() {
const jsonTextarea = document.getElementById('provider-options-json');
const hiddenField = document.getElementById('provider-options-hidden');

try {
const parsed = JSON.parse(jsonTextarea.value || '{}');
hiddenField.value = JSON.stringify(parsed);
return true;
} catch (e) {
alert('âŒ Erreur JSON:\n' + e.message);
return false;
}
}

// â”€â”€ AUTRES FONCTIONS (MODEL CAPABILITIES) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateModelOptions(providerName) {
const select = document.getElementById('model-select');
const optgroups = select.querySelectorAll('optgroup');

optgroups.forEach(group => {
const isMatch = group.dataset.provider === providerName;
group.style.display = isMatch ? '' : 'none';
});

const currentModelId = select.value;
if (! modelCapabilities[currentModelId] || modelCapabilities[currentModelId].provider !== providerName) {
for (const opt of select.querySelectorAll('option')) {
if (opt.dataset.provider === providerName) {
select.value = opt.value;
break;
}
}
}

updateFormVisibility();
}

function updateFormVisibility() {
const modelId = document.getElementById('model-select').value;
const caps = modelCapabilities[modelId] || {
top_k: true
};

const sections = {
'section-top-k': caps.topK
};

for (const [id, visible] of Object.entries(sections)) {
const el = document.getElementById(id);
if (el) {
el.style.display = visible ? '' : 'none';
}
}

// Les Preset LLM sont exclusivement des modÃ¨les de Chat. On ne masque plus ces cartes.
updateCapsBadges(modelId, caps);
}

function updateCapsBadges(modelId, caps) {
const displayEl = document.getElementById('model-caps-display');
if (! displayEl) 
return;



const body = displayEl.querySelector('.synapse-admin__card-body');
if (! body) 
return;



body.innerHTML = '';

const capabilities = [
{
key: 'thinking',
label: 'Thinking',
icon: 'brain'
}, {
key: 'functionCalling',
label: 'Tool Calls',
icon: 'wrench'
}, {
key: 'safetySettings',
label: 'Safety Filters',
icon: 'shield'
}, {
key: 'streaming',
label: 'Streaming',
icon: 'activity'
}
];

let hasCapabilities = false;
for (const {key, label, icon}
of capabilities) {
if (caps[key]) {
const pill = document.createElement('span');
pill.className = 'synapse-admin__capability-pill synapse-admin__capability-pill--active';
pill.innerHTML = `<i data-lucide="${icon}" style="width: 14px; height: 14px;"></i> ${label}`;
body.appendChild(pill);
hasCapabilities = true;
}
}

if (! hasCapabilities) {
body.innerHTML = '<p style="margin: 0; color: var(--synapse-admin-text-secondary); font-size: 0.9rem;">Aucune capacitÃ© spÃ©ciale</p>';
} else if (typeof lucide !== 'undefined') {
lucide.createIcons();
}
}

// â”€â”€ INITIALISATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
const providerSelect = document.getElementById('provider-select');
const modelSelect = document.getElementById('model-select');

providerSelect.addEventListener('change', (e) => updateModelOptions(e.target.value));
modelSelect.addEventListener('change', () => {
updateFormVisibility();
renderDynamicFields(providerSelect.value);
});

// Ã‰couter les changements du textarea JSON pour mettre Ã  jour les champs
const jsonTextarea = document.getElementById('provider-options-json');
if (jsonTextarea) {
jsonTextarea.addEventListener('change', () => {
renderDynamicFields(providerSelect.value);
});
}

updateModelOptions(providerSelect.value);
updateFormVisibility();
renderDynamicFields(providerSelect.value);
});
	</script>
{% endblock %}
