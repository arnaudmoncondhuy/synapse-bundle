name: Split Monorepo to Separate Repos

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  split:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - local: packages/core
            repo: synapse-core
            name: Core
          - local: packages/admin
            repo: synapse-admin
            name: Admin
          - local: packages/chat
            repo: synapse-chat
            name: Chat
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Split ${{ matrix.package.name }} package
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Clone target repo
          git clone "https://x-access-token:${{ secrets.SYNAPSE_SPLIT_TOKEN }}@github.com/arnaudmoncondhuy/${{ matrix.package.repo }}.git" target-repo

          # Copy package files to target repo
          cp -r ${{ matrix.package.local }}/* target-repo/

          # Commit and push
          cd target-repo
          git add .
          git commit -m "Sync from monorepo" --allow-empty || true
          git push origin main
          cd ..
          rm -rf target-repo
