name: Split Monorepo to Separate Repos

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  split:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - local: packages/core
            repo: synapse-core
            name: Core
          - local: packages/admin
            repo: synapse-admin
            name: Admin
          - local: packages/chat
            repo: synapse-chat
            name: Chat
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Split ${{ matrix.package.name }} package
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git subtree split --prefix=${{ matrix.package.local }} -b split-branch
          git push -u "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/arnaudmoncondhuy/${{ matrix.package.repo }}.git" split-branch:main --force
          git branch -D split-branch
