services:
    _defaults:
        autowire: true
        autoconfigure: true

    # Infra
    ArnaudMoncondhuy\SynapseBundle\Service\Infra\GoogleAuthService:
        arguments:
            $serviceAccountJsonPath: '%synapse.vertex.service_account_json%'

    ArnaudMoncondhuy\SynapseBundle\Service\Infra\GeminiClient:
        arguments:
            $httpClient: '@http_client'
            $googleAuthService: '@ArnaudMoncondhuy\SynapseBundle\Service\Infra\GoogleAuthService'
            $model: '%synapse.model%'
            $vertexProjectId: '%synapse.vertex.project_id%'
            $vertexRegion: '%synapse.vertex.region%'
            $thinkingEnabled: '%synapse.thinking.enabled%'
            $thinkingBudget: '%synapse.thinking.budget%'
            $safetySettingsEnabled: '%synapse.safety_settings.enabled%'
            $safetyDefaultThreshold: '%synapse.safety_settings.default_threshold%'
            $safetyThresholds: '%synapse.safety_settings.thresholds%'
            $generationTemperature: '%synapse.generation_config.temperature%'
            $generationTopP: '%synapse.generation_config.top_p%'
            $generationTopK: '%synapse.generation_config.top_k%'
            $generationMaxOutputTokens: '%synapse.generation_config.max_output_tokens%'
            $generationStopSequences: '%synapse.generation_config.stop_sequences%'
            $contextCachingEnabled: '%synapse.context_caching.enabled%'
            $contextCachingId: '%synapse.context_caching.cached_content_id%'
            $configProvider: '@ArnaudMoncondhuy\SynapseBundle\Contract\ConfigProviderInterface'

    # Default implementations (can be overridden by user)
    ArnaudMoncondhuy\SynapseBundle\Service\DatabaseConfigProvider:
        arguments:
            $scope: 'default'

    ArnaudMoncondhuy\SynapseBundle\Service\Impl\SessionConversationHandler: ~

    ArnaudMoncondhuy\SynapseBundle\Service\Impl\DefaultContextProvider: ~

    ArnaudMoncondhuy\SynapseBundle\Service\Context\UserAwareContextProvider:
        arguments:
            $language: '%synapse.context.language%'

    ArnaudMoncondhuy\SynapseBundle\Service\Security\DefaultPermissionChecker:
        arguments:
            $adminRole: '%synapse.security.admin_role%'

    ArnaudMoncondhuy\SynapseBundle\Service\Formatter\MessageFormatter:
        arguments:
            $encryptionService: '@?ArnaudMoncondhuy\SynapseBundle\Contract\EncryptionServiceInterface'

    # Aliases for interfaces (use default implementations)
    ArnaudMoncondhuy\SynapseBundle\Contract\ConfigProviderInterface:
        alias: ArnaudMoncondhuy\SynapseBundle\Service\DatabaseConfigProvider

    ArnaudMoncondhuy\SynapseBundle\Contract\ConversationHandlerInterface:
        alias: ArnaudMoncondhuy\SynapseBundle\Service\Core\DatabaseConversationHandler

    ArnaudMoncondhuy\SynapseBundle\Contract\ContextProviderInterface:
        alias: ArnaudMoncondhuy\SynapseBundle\Service\Impl\DefaultContextProvider

    ArnaudMoncondhuy\SynapseBundle\Contract\PermissionCheckerInterface:
        alias: ArnaudMoncondhuy\SynapseBundle\Service\Security\DefaultPermissionChecker

    ArnaudMoncondhuy\SynapseBundle\Contract\MessageFormatterInterface:
        alias: ArnaudMoncondhuy\SynapseBundle\Service\Formatter\MessageFormatter

    # Logic
    ArnaudMoncondhuy\SynapseBundle\Service\PersonaRegistry:
        arguments:
            $configPath: '%synapse.personas_path%'

    ArnaudMoncondhuy\SynapseBundle\Service\PromptBuilder:
        arguments:
            $personaRegistry: '@ArnaudMoncondhuy\SynapseBundle\Service\PersonaRegistry'
            $configProvider: '@ArnaudMoncondhuy\SynapseBundle\Contract\ConfigProviderInterface'

    # Main service
    ArnaudMoncondhuy\SynapseBundle\Service\ChatService:
        arguments:
            $geminiClient: '@ArnaudMoncondhuy\SynapseBundle\Service\Infra\GeminiClient'
            $promptBuilder: '@ArnaudMoncondhuy\SynapseBundle\Service\PromptBuilder'
            $tools: !tagged_iterator synapse.tool
            $cache: '@cache.app'
            $configProvider: '@ArnaudMoncondhuy\SynapseBundle\Contract\ConfigProviderInterface'

    # UI Layout Resolution
    ArnaudMoncondhuy\SynapseBundle\Service\SynapseLayoutResolver:
        arguments:
            $layoutMode: '%synapse.ui.layout_mode%'

    # Twig Integration
    ArnaudMoncondhuy\SynapseBundle\Twig\SynapseRuntime:
        tags: ['twig.runtime']

    ArnaudMoncondhuy\SynapseBundle\Twig\SynapseExtension:
        tags: ['twig.extension']
    ArnaudMoncondhuy\SynapseBundle\Controller\Api\ChatApiController:
        autowire: true
        autoconfigure: true
        tags: ['controller.service_arguments']




    ArnaudMoncondhuy\SynapseBundle\Controller\Api\ResetController:
        tags: ['controller.service_arguments']

    ArnaudMoncondhuy\SynapseBundle\Controller\Api\DebugController:
        tags: ['controller.service_arguments']

    # Repositories (entités concrètes du bundle)
    ArnaudMoncondhuy\SynapseBundle\Repository\TokenUsageRepository:
        arguments:
            $registry: '@doctrine'
        tags: ['doctrine.repository_service']

    ArnaudMoncondhuy\SynapseBundle\Repository\SynapseConfigRepository:
        arguments:
            $registry: '@doctrine'
        tags: ['doctrine.repository_service']

    # Accounting (tracking des tâches automatisées)
    ArnaudMoncondhuy\SynapseBundle\Service\Accounting\TokenAccountingService: ~
