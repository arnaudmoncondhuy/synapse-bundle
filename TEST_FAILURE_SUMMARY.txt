================================================================================
                    36 PHPUnit TEST FAILURES - COMPLETE ANALYSIS
================================================================================

Generated: 2026-02-22
Test Suite: PHPUnit 13.0.5
Total Tests: 261 | Passing: 225 | Failing: 36 (19 Errors + 17 Failures)
Current Coverage: 86.2% (225 passing)

================================================================================
EXECUTIVE SUMMARY
================================================================================

The 36 failing tests fall into 7 distinct categories, each with different root
causes and remediation strategies. The failures are NOT random - they follow
clear patterns that can be fixed with targeted changes to a small number of files.

Quick Wins (can fix 12 tests in under 10 minutes):
  1. MessageFormatter: Add Gemini format support (9 tests)
  2. OvhAiClientTest: Initialize mock properties (3 tests)

Medium Effort (10-20 minutes for 8-10 tests):
  3. ChatServiceTest: Fix event handling (4 tests)
  4. OvhAiClientTest: Fix response structure (3 tests)
  5. GeminiClientTest: Fix error handling (1 test)
  6. LlmClientRegistryTest: Fix singleton pattern (2 tests)

Blocking Issue (10-20 minutes but fixes 12 tests):
  7. Doctrine setup: Missing bundle classes in test environment (12 tests)

================================================================================
FAILURE CATEGORIES (IN PRIORITY ORDER)
================================================================================

CATEGORY 1: MESSAGEFORMATTERTEST (9 Failures) - 25% of failures
─────────────────────────────────────────────────────────────────────────────
File:     /src/Core/Formatter/MessageFormatter.php (lines 41-56)
Error:    "Failed asserting that actual size 0 matches expected size [1-3]"
Root:     Method only recognizes OpenAI format ('content'), not Gemini ('parts')
Impact:   9 tests failing with identical pattern
Effort:   LOW (1 line change: add || isset($entity['parts']))
Status:   READY TO FIX

Current Code (BROKEN):
  if (isset($entity['role']) && isset($entity['content'])) {

Fixed Code:
  if (isset($entity['role']) && (isset($entity['content']) || isset($entity['parts']))) {

Also need to handle 'parts' format in decryption logic (see DETAILED_FIXES.md)

Failing Tests:
  ✗ testEntitiesToApiFormatConvertsApiFormat (line 49)
  ✗ testEntitiesToApiFormatWithSerializedArray (line 73)
  ✗ testEntitiesToApiFormatDecryptsSerializedContent (line 108)
  ✗ testEntitiesToApiFormatDecryptsSerializedArray (line 141)
  ✗ testEntitiesToApiFormatSkipsDecryptionForPlaintext (line 172)
  ✗ testEntitiesToApiFormatWithoutEncryptionService (line 193)
  ✗ testEntitiesToApiFormatWithMultipleSerializedMessages (line 220)
  ✗ testEntitiesToApiFormatWithMultipleEncryptedMessages (line 290)
  ✗ testEntitiesToApiFormatWithCapitalizedRoles (line 311)

─────────────────────────────────────────────────────────────────────────────
CATEGORY 2: DOCTRINE SETUP (12 Errors) - 33% of failures
─────────────────────────────────────────────────────────────────────────────
Files:    /src/Storage/Repository/SynapseModelRepository.php:14
          /src/Storage/Repository/SynapsePresetRepository.php (+ others)
Error:    "Class 'Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository' not found"
Root:     Doctrine classes not available in test environment
Impact:   12 tests failing (all TokenAccountingServiceTest + 2 functional tests)
Effort:   MEDIUM (test infrastructure investigation)
Status:   INVESTIGATION REQUIRED

Failing Tests:
  TOKENACCOUNTINGSERVICETEST (10 errors):
  ✗ testLogUsageWithInternalFormat (line 21)
  ✗ testLogUsageWithVertexFormat (line 21)
  ✗ testLogUsageCalculatesTotalTokens (line 21)
  ✗ testLogUsageWithUserAndConversationId (line 21)
  ✗ testLogUsageStoresCostInMetadata (line 21)
  ✗ testLogFromGeminiResponse (line 21)
  ✗ testLogUsageWithZeroTokens (line 21)
  ✗ testLogUsageWithUnknownModel (line 21)
  ✗ testLogUsageConvertsIntUserIdToString (line 21)
  ✗ testLogUsagePreservesProvidedMetadata (line 21)

  CHATAPICCONTROLLERTEST (2 errors):
  ✗ testChatEndpointIsReachableAndReturnsNdjson
  ✗ testChatEndpointRejectsMissingApiKey

Investigation Steps:
  1. Check phpunit.xml.dist - does it load Doctrine bundles?
  2. Check tests/bootstrap.php - is Doctrine initialized?
  3. Check if test kernel has proper fixtures/setup
  4. Consider: Mock ServiceEntityRepository or create test-specific base class

─────────────────────────────────────────────────────────────────────────────
CATEGORY 3: OVHAICLIENTTEST (6 Errors/Failures) - 17% of failures
─────────────────────────────────────────────────────────────────────────────
File:     /tests/Unit/Service/Infra/OvhAiClientTest.php

3 ERRORS (Property Initialization):
Location:   Lines 83, 165, 214
Error:      "Typed property ModelCapabilities::$systemPrompt must not be accessed before initialization"
Root:       Mock objects don't have required properties initialized
Effort:     LOW (add method mock returns)
Status:     READY TO FIX

Failing Tests:
  ✗ testStreamGenerateContentAcceptsOpenAiFormat (line 83)
    Error: Accesses uninitialized $systemPrompt at OvhAiClient.php:87
  ✗ testOvhSupportsToolsIfCapabilityEnabled (line 165)
    Error: Accesses uninitialized $functionCalling at OvhAiClient.php:385
  ✗ testStreamGenerateContentWithCustomModel (line 214)
    Error: Accesses uninitialized $systemPrompt at OvhAiClient.php:87

Fix Pattern:
  Current: $capabilities = $this->createMock(ModelCapabilities::class);
  Fixed:  
    $capabilities = $this->createMock(ModelCapabilities::class);
    $capabilities->method('getSystemPrompt')->willReturn(true);
    $capabilities->method('getFunctionCalling')->willReturn(true);

3 FAILURES (Response Structure):
Location:   Lines 112, 136, 192
Error:      Various - missing keys, null values
Root:       Response structure doesn't match expected format
Effort:     MEDIUM (understand response structure)
Status:     INVESTIGATION REQUIRED

Failing Tests:
  ✗ testOvhIsOpenAiPassthrough (line 112)
    Error: Expected key 'raw_request_body' not found
  ✗ testOvhSafetyDisabledByDefault (line 136)
    Error: Expected false but got null
  ✗ testDefaultModelIsGptOss20b (line 192)
    Error: Expected array but got null

─────────────────────────────────────────────────────────────────────────────
CATEGORY 4: CHATSERVICETEST (4 Errors/Failures) - 11% of failures
─────────────────────────────────────────────────────────────────────────────
File:     /tests/Unit/Service/ChatServiceTest.php

4 SEPARATE ISSUES:

Issue 1: testAskDispatchesSynapsePrePromptEvent (line 148)
  Error: "dispatch() was not expected to be called more than once"
  Root:  ChatService.php:137 dispatches event repeatedly
  Effort: LOW-MEDIUM
  Status: INVESTIGATION REQUIRED

Issue 2: testAskAccumulatesChunksIntoAnswer (line 235)
  Error: "Argument #2 must be string, array given"
  Root:  Test expects string but ChatService returns array chunk
  Effort: LOW
  Status: READY TO FIX (change assertion or extract text)

Issue 3: testAskMaintainsOpenAiCanonicalFormat (line 348)
  Error: "Argument #1 must be SynapsePrePromptEvent, got SynapseChunkReceivedEvent"
  Root:  Event type mismatch - closure type hints wrong event type
  Effort: LOW
  Status: READY TO FIX (change type hint to match dispatched event)

Issue 4: testAskWithDebugModeEnabled (line 282)
  Error: "Array doesn't have key 'debug'"
  Root:  Debug info not included in response when debug=true
  Effort: MEDIUM
  Status: INVESTIGATION REQUIRED (check debug event handling)

─────────────────────────────────────────────────────────────────────────────
CATEGORY 5: GEMINICLIENTTEST (1 Error) - 3% of failures
─────────────────────────────────────────────────────────────────────────────
File:     /tests/Unit/Service/Infra/GeminiClientTest.php
Location: Line 284
Error:    "RuntimeException: Gemini API Error: Network error"
Root:     Exception not caught by error handler
Effort:   LOW (review exception handling)
Status:   INVESTIGATION REQUIRED

Failing Test:
  ✗ testGenerateContentHandlesHttpException (line 284)
    Error: Mock exception thrown at line 281
    Expected: Caught and handled
    Actual:   Exception propagates

─────────────────────────────────────────────────────────────────────────────
CATEGORY 6: LLMCLIENTREGISTRYTEST (2 Failures) - 6% of failures
─────────────────────────────────────────────────────────────────────────────
File:     /tests/Unit/Service/LlmClientRegistryTest.php

Failing Tests:
  ✗ testExceptionMessageListsAvailableProviders
    Error: RuntimeException not thrown
    Root:  Registry logic or exception throwing changed
    Status: INVESTIGATION REQUIRED

  ✗ testRegistryStoresUniqueClientInstances (line 239)
    Error: Two variables don't reference same object
    Root:  Registry not caching/returning same instance
    Status: Check singleton implementation

Effort: LOW-MEDIUM
Status: INVESTIGATION REQUIRED

================================================================================
FIX PRIORITY ROADMAP
================================================================================

PHASE 1: QUICK WINS (Estimated 10 minutes, 12 tests fixed)
────────────────────────────────────────────────────────────

  FIX 1.1: MessageFormatter.php - Add Gemini format support
  ├─ File: /src/Core/Formatter/MessageFormatter.php
  ├─ Change: Lines 41-56 (add || isset($entity['parts']))
  ├─ Tests Fixed: 9
  ├─ Effort: 2 minutes
  └─ Details: See DETAILED_FIXES.md "PRIORITY 2"

  FIX 1.2: OvhAiClientTest.php - Initialize mock properties
  ├─ File: /tests/Unit/Service/Infra/OvhAiClientTest.php
  ├─ Change: Add willReturn() mocks at lines 83, 165, 214
  ├─ Tests Fixed: 3
  ├─ Effort: 5 minutes
  └─ Details: See DETAILED_FIXES.md "PRIORITY 3"

PHASE 2: INVESTIGATION (Estimated 10-15 minutes)
───────────────────────────────────────────────────

  INV 2.1: Doctrine Setup
  ├─ Check: phpunit.xml.dist
  ├─ Check: tests/bootstrap.php
  ├─ Status: BLOCKING (affects 12 tests)
  └─ Estimated Impact: 12 tests if successful

  INV 2.2: ChatServiceTest Event Handling
  ├─ Check: /src/Core/Chat/ChatService.php:137
  ├─ Check: ChatServiceTest.php lines 148, 235, 348, 282
  ├─ Status: Multiple separate issues
  └─ Estimated Impact: 2-4 tests

PHASE 3: IMPLEMENTATION (Estimated 20-30 minutes)
──────────────────────────────────────────────────

  FIX 3.1: ChatServiceTest - Fix event issues (4 tests)
  FIX 3.2: OvhAiClientTest - Fix response structure (3 tests)
  FIX 3.3: GeminiClientTest - Fix exception handling (1 test)
  FIX 3.4: LlmClientRegistryTest - Fix singleton pattern (2 tests)

ESTIMATED TOTAL IMPROVEMENT:
  Phase 1 (Quick Wins): +12 tests (261 - 36 = 225 + 12 = 237)
  Phase 2 (Investigation): +8-12 tests (pending Doctrine fix)
  Phase 3 (Implementation): +8-10 tests
  ─────────────────────────────────────────
  Total Potential: +28-34 tests fixed (77-94% of failures)
  Best Case: 259/261 tests passing (99.2% coverage)

================================================================================
DETAILED INFORMATION IN RELATED FILES
================================================================================

/home/ubuntu/stacks/synapse-bundle/TEST_RESULTS_FULL.txt
  → Complete PHPUnit output (raw test results)

/home/ubuntu/stacks/synapse-bundle/TEST_FAILURE_ANALYSIS.md
  → Markdown analysis with all failure details

/home/ubuntu/stacks/synapse-bundle/DETAILED_FIXES.md
  → Code locations and specific fix instructions

================================================================================
RECOMMENDED NEXT STEPS
================================================================================

1. START WITH: MessageFormatter.php fix (9 tests, 2 minutes)
2. THEN: OvhAiClientTest mock initialization (3 tests, 5 minutes)
3. THEN: Investigate Doctrine setup (10-15 minutes)
4. THEN: Fix remaining issues based on investigation results

This prioritized approach gives you visible progress (12 tests fixed)
in the first 10-15 minutes, then addresses the blocking Doctrine issue.

================================================================================
