╔════════════════════════════════════════════════════════════════════════════════╗
║                        COMPLETE FAILURE BREAKDOWN                              ║
║                          36 Tests - All Details                                ║
╚════════════════════════════════════════════════════════════════════════════════╝

═══ 1. MESSAGEFORMATTERTEST (9 failures - ONE FIX FIXES ALL)
═══════════════════════════════════════════════════════════════════════════════

File: /src/Core/Formatter/MessageFormatter.php
Issue: Only handles OpenAI format ('content' key), not Gemini format ('parts')
Fix: Change line 41 from:
       if (isset($entity['role']) && isset($entity['content'])) {
     to:
       if (isset($entity['role']) && (isset($entity['content']) || isset($entity['parts']))) {

Then update decryption logic to handle 'parts' array format (see DETAILED_FIXES.md)

Failing Tests (all in /tests/Unit/Service/Formatter/MessageFormatterTest.php):
  ✗ testEntitiesToApiFormatConvertsApiFormat (line 49)
  ✗ testEntitiesToApiFormatWithSerializedArray (line 73)
  ✗ testEntitiesToApiFormatDecryptsSerializedContent (line 108)
  ✗ testEntitiesToApiFormatDecryptsSerializedArray (line 141)
  ✗ testEntitiesToApiFormatSkipsDecryptionForPlaintext (line 172)
  ✗ testEntitiesToApiFormatWithoutEncryptionService (line 193)
  ✗ testEntitiesToApiFormatWithMultipleSerializedMessages (line 220)
  ✗ testEntitiesToApiFormatWithMultipleEncryptedMessages (line 290)
  ✗ testEntitiesToApiFormatWithCapitalizedRoles (line 311)

Effort: 2 minutes
Impact: 9 tests fixed
Status: READY TO FIX


═══ 2. TOKENACCOUNTINGSERVICETEST (10 errors - DOCTRINE ISSUE)
═══════════════════════════════════════════════════════════════════════════════

File: /src/Storage/Repository/SynapseModelRepository.php:14
Error: Class "Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository" not found
Root: Doctrine classes not available in test environment

All tests in /tests/Unit/Service/Accounting/TokenAccountingServiceTest.php fail at line 21:
  ✗ testLogUsageWithInternalFormat
  ✗ testLogUsageWithVertexFormat
  ✗ testLogUsageCalculatesTotalTokens
  ✗ testLogUsageWithUserAndConversationId
  ✗ testLogUsageStoresCostInMetadata
  ✗ testLogFromGeminiResponse
  ✗ testLogUsageWithZeroTokens
  ✗ testLogUsageWithUnknownModel
  ✗ testLogUsageConvertsIntUserIdToString
  ✗ testLogUsagePreservesProvidedMetadata

Investigation needed:
  - Check phpunit.xml.dist for Doctrine configuration
  - Check tests/bootstrap.php for initialization
  - May need to mock ServiceEntityRepository

Effort: 10-20 minutes
Impact: 10 tests fixed
Status: INVESTIGATION REQUIRED


═══ 3. CHATAPICCONTROLLERTEST (2 functional test errors - DOCTRINE)
═══════════════════════════════════════════════════════════════════════════════

File: config/services.yaml
Error: Service id "...TokenUsageRepository" looks like FQCN but class doesn't exist
Root: Same Doctrine setup issue

Tests in /tests/Functional/Api/ChatApiControllerTest.php:
  ✗ testChatEndpointIsReachableAndReturnsNdjson
  ✗ testChatEndpointRejectsMissingApiKey

Fix: Same as TokenAccountingServiceTest (Doctrine setup)
Effort: Same as above (combined effort)
Impact: 2 tests fixed
Status: INVESTIGATION REQUIRED


═══ 4. OVHAICLIENTTEST PROPERTY ERRORS (3 errors - MOCK PROPERTIES)
═══════════════════════════════════════════════════════════════════════════════

File: /tests/Unit/Service/Infra/OvhAiClientTest.php
Error: "Typed property ModelCapabilities::$systemPrompt must not be accessed before initialization"
Root: Mock objects not fully initialized

Failing Tests:
  ✗ testStreamGenerateContentAcceptsOpenAiFormat (line 83)
    Issue at: OvhAiClient.php:87 accesses uninitialized $systemPrompt
  ✗ testOvhSupportsToolsIfCapabilityEnabled (line 165)
    Issue at: OvhAiClient.php:385 accesses uninitialized $functionCalling
  ✗ testStreamGenerateContentWithCustomModel (line 214)
    Issue at: OvhAiClient.php:87 accesses uninitialized $systemPrompt

Fix: Add property mocks at lines 83, 165, 214:
     $capabilities->method('getSystemPrompt')->willReturn(true);
     $capabilities->method('getFunctionCalling')->willReturn(true);

Effort: 5 minutes
Impact: 3 tests fixed
Status: READY TO FIX


═══ 5. OVHAICLIENTTEST RESPONSE ERRORS (3 failures - STRUCTURE)
═══════════════════════════════════════════════════════════════════════════════

File: /tests/Unit/Service/Infra/OvhAiClientTest.php
Root: Response structure doesn't match expected format

Failing Tests:
  ✗ testOvhIsOpenAiPassthrough (line 112)
    Error: Array doesn't have key 'raw_request_body'
  ✗ testOvhSafetyDisabledByDefault (line 136)
    Error: Expected false but got null
  ✗ testDefaultModelIsGptOss20b (line 192)
    Error: Expected array but got null

Investigation needed:
  - Check what OvhAiClient.php returns
  - Verify response structure includes required keys
  - Check default values for safety and model settings

Effort: 10 minutes
Impact: 3 tests fixed
Status: INVESTIGATION REQUIRED


═══ 6. CHATSERVICETEST ISSUES (4 errors/failures - MULTIPLE PROBLEMS)
═══════════════════════════════════════════════════════════════════════════════

File: /tests/Unit/Service/ChatServiceTest.php
Root: Multiple separate issues

Issue 1 - testAskDispatchesSynapsePrePromptEvent (line 148)
  Error: "dispatch(...) was not expected to be called more than once"
  Root: ChatService.php:137 dispatches event repeatedly
  Status: INVESTIGATION REQUIRED

Issue 2 - testAskAccumulatesChunksIntoAnswer (line 235)
  Error: "Argument #2 must be string, array given"
  Root: Test expects string, ChatService returns array chunk
  Status: READY TO FIX
  Fix: Extract text from array or change assertion to handle array

Issue 3 - testAskMaintainsOpenAiCanonicalFormat (line 348)
  Error: "Argument #1 must be SynapsePrePromptEvent, got SynapseChunkReceivedEvent"
  Root: Event type mismatch - closure type hint wrong
  Status: READY TO FIX
  Fix: Change type hint from SynapsePrePromptEvent to accept dispatched event

Issue 4 - testAskWithDebugModeEnabled (line 282)
  Error: "Array doesn't have key 'debug'"
  Root: Debug info not included in response
  Status: INVESTIGATION REQUIRED
  Check: DebugLogSubscriber and debug event handling

Effort: 10-15 minutes
Impact: 2-4 tests fixed
Status: PARTIALLY READY


═══ 7. GEMINICLIENTTEST EXCEPTION (1 error - ERROR HANDLING)
═══════════════════════════════════════════════════════════════════════════════

File: /tests/Unit/Service/Infra/GeminiClientTest.php
Error: "RuntimeException: Gemini API Error: Network error"
Root: Exception not caught by error handler

Failing Test:
  ✗ testGenerateContentHandlesHttpException (line 284)
    Mock throws exception at line 281
    Should be caught at GeminiClient.php:103
    Instead: Exception propagates

Investigation needed:
  - Check generateContent method error handling
  - Verify mock exception is properly set up
  - Check if exception type is correctly caught

Effort: 5-10 minutes
Impact: 1 test fixed
Status: INVESTIGATION REQUIRED


═══ 8. LLMCLIENTREGISTRYTEST BEHAVIOR (2 failures - SINGLETON)
═══════════════════════════════════════════════════════════════════════════════

File: /tests/Unit/Service/LlmClientRegistryTest.php
Root: Registry behavior issues

Failing Tests:
  ✗ testExceptionMessageListsAvailableProviders
    Error: RuntimeException not thrown as expected
    Root: Registry logic or exception throwing changed
  ✗ testRegistryStoresUniqueClientInstances (line 239)
    Error: Two variables don't reference same object
    Root: Registry not caching/returning same instance

Investigation needed:
  - Check LlmClientRegistry implementation
  - Verify singleton/caching pattern is implemented
  - Check exception throwing in error cases

Effort: 5-10 minutes
Impact: 2 tests fixed
Status: INVESTIGATION REQUIRED


════════════════════════════════════════════════════════════════════════════════
SUMMARY TABLE
════════════════════════════════════════════════════════════════════════════════

Test Category              Count  Status               Effort   Impact
─────────────────────────────────────────────────────────────────────────────
MessageFormatterTest         9    READY TO FIX         2 min    9 tests
Doctrine Setup              12    INVESTIGATION        15 min   12 tests
OvhAiClientTest (mock)       3    READY TO FIX         5 min    3 tests
ChatServiceTest              4    PARTIALLY READY      15 min   2-4 tests
OvhAiClientTest (response)   3    INVESTIGATION        10 min   3 tests
GeminiClientTest             1    INVESTIGATION        10 min   1 test
LlmClientRegistryTest        2    INVESTIGATION        10 min   2 tests
─────────────────────────────────────────────────────────────────────────────
TOTAL                       36                        ~60 min  26-34 tests

════════════════════════════════════════════════════════════════════════════════

QUICK WINS (Do these first - 7 minutes):
  1. MessageFormatterTest (9 tests) - 2 minutes
  2. OvhAiClientTest mock properties (3 tests) - 5 minutes
  
After quick wins: 237/261 passing (90.8%)

════════════════════════════════════════════════════════════════════════════════
